<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>MafAbends.st</title>
<link rev="made" href="mailto:" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>MafAbends.st</h1>

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<ul>

		<li><a href="#mafabends_string_test_suite">MafAbends String Test Suite</a></li>
		<ul>

			<li><a href="#author">AUTHOR</a></li>
			<li><a href="#synopsis">SYNOPSIS</a></li>
			<li><a href="#description">DESCRIPTION</a></li>
			<li><a href="#test_alarm_condition">Test Alarm Condition</a></li>
			<li><a href="#test_no_alarm_condition">Test No Alarm Condition</a></li>
			<li><a href="#test_no_alarm_condition">Test No Alarm Condition</a></li>
			<li><a href="#supporting_subroutines">Supporting Subroutines</a></li>
		</ul>

	</ul>

</ul>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#test1-">package main</a>
<ul>
<li><a href="#test1-">test1</a></li>
<li><a href="#test2-">test2</a></li>
<li><a href="#test3-">test3</a></li>
<li><a href="#page-">page</a></li>
<li><a href="#env_setup-">env_setup</a></li>
<li><a href="#db_setup_for_test1-">db_setup_for_test1</a></li>
<li><a href="#acpa_cleanup-">acpa_cleanup</a></li>
<li><a href="#db_connect-">db_connect</a></li>
<li><a href="#get_insert_statements-">get_insert_statements</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<hr />
<pre>#!/usr/local/bin/perl

</pre><p></p>
<h2><a name="mafabends_string_test_suite">MafAbends String Test Suite</a></h2>
<p>
</p>
<h3><a name="author">AUTHOR</a></h3>
<p>Pete Chudykowski, USCC</p>
<p>
</p>
<h3><a name="synopsis">SYNOPSIS</a></h3>
<pre>
  perl MafAbends.st [ MafAbends.xml ]</pre>
<p>
</p>
<h3><a name="description">DESCRIPTION</a></h3>
<p>String tests MafAbends Monitor Audit.
First the environment is prepared for testing using information in <em>config.xml</em>
String tests are then performed using the following iteration:</p>
<ul>
<li><strong><a name="item_set_up_the_environment_for_the_next_string_test_co">Set up the environment for the next string test condition</a></strong><br />
</li>
<li><strong><a name="item_execute_mafabends_2epl_with_parameters_obtained_fr">Execute MafAbends.pl with parameters obtained from the configuration file</a></strong><br />
</li>
<li><strong><a name="item_read_the_results_from_stdout">Read the results from STDOUT</a></strong><br />
</li>
<li><strong><a name="item_page_and_email_if_applicable">Page and email if applicable</a></strong><br />
</li>
<li><strong><a name="item_read_the_generated_log">Read the generated log</a></strong><br />
</li>
<li><strong><a name="item_produce_test_report">Produce test report</a></strong><br />
</li>
</ul>
<pre>

<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">warnings</span><span class="sc">;</span>

<span class="k">BEGIN</span>
<span class="s">{</span>
  <span class="k">unshift</span> <span class="i">@INC</span><span class="cm">,</span> <span class="q">'../'</span><span class="sc">;</span>
  <span class="i">$|</span> =<span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<span class="k">use</span> <span class="w">Carp</span><span class="sc">;</span>         <span class="c"># for pretty error reporting</span>
<span class="k">use</span> <span class="w">Data::Dumper</span><span class="sc">;</span> <span class="c"># for debugging data structures</span>

<span class="k">use</span> <span class="w">lib</span> <span class="q">'./MIME'</span><span class="sc">;</span> <span class="c"># location of the MIME::Lite module</span>
<span class="k">use</span> <span class="w">MIME::Lite</span><span class="sc">;</span>   <span class="c"># for sending email</span>
<span class="k">use</span> <span class="w">XML::Simple</span><span class="sc">;</span>  <span class="c"># for simple XML parsing</span>
<span class="k">use</span> <span class="w">USCDB</span><span class="sc">;</span>        <span class="c"># to connect to database</span>

<span class="c"># Set up the environment for testing and declare globals.</span>
<span class="k">my</span> <span class="i">$config</span> = <span class="i">env_setup</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$executable</span> = <span class="i">$config</span>-&gt;{<span class="w">executable</span>}<span class="sc">;</span>
<span class="k">my</span> <span class="i">%args</span> = <span class="i">%</span>{<span class="i">$config</span>-&gt;{<span class="w">params</span>}}<span class="sc">;</span>
<span class="k">my</span> <span class="i">$pager</span> = <span class="i">$config</span>-&gt;{<span class="w">pager</span>}<span class="sc">;</span>
<span class="k">my</span> <span class="i">$email</span> = <span class="i">$config</span>-&gt;{<span class="w">email</span>}<span class="sc">;</span>

<span class="c"># Run Strig Tests</span>
<span class="k">print</span> <span class="q">&quot;\nString Test 1: Alarm Condition\n&quot;</span><span class="sc">;</span>
<span class="i">page</span><span class="s">(</span><span class="i">test1</span><span class="s">(</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span>
<span class="k">print</span> <span class="q">&quot;\nString Test 2: No Alarm Condition\n&quot;</span><span class="sc">;</span>
<span class="i">page</span><span class="s">(</span><span class="i">test2</span><span class="s">(</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span>
<span class="k">print</span> <span class="q">&quot;\nString Test 3: No Alarm Condition\n&quot;</span><span class="sc">;</span>
<span class="i">page</span><span class="s">(</span><span class="i">test3</span><span class="s">(</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="test_alarm_condition">Test Alarm Condition</a></h3>
<p>Tests Audit behavior when alarm condition is present.</p>
<ul>
<li><strong><a name="item_sets_up_the_environment_in_a_way_to_simulate_the_a">Sets up the environment in a way to simulate the alarm 
condition for this Audit</a></strong><br />
</li>
<li><strong><a name="item_executes_a_system_call_to_the_audit_executable_wit">Executes a system call to the Audit executable with 
appropriate command line arguments</a></strong><br />
</li>
<li><strong><a name="item_cleans_up_the_environment">Cleans up the environment</a></strong><br />
</li>
<li><strong><a name="item_returns_the_stdout_of_the_audit">Returns the STDOUT of the Audit</a></strong><br />
</li>
</ul>
<pre>
<a name="test1-"></a><span class="k">sub </span><span class="m">test1</span>
<span class="s">{</span>
  <span class="i">db_setup_for_test1</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$parameters</span> = <span class="q">''</span><span class="sc">;</span>
  <span class="k">foreach</span> <span class="k">my</span> <span class="i">$arg</span> <span class="s">(</span><span class="k">keys</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span><span class="s">)</span>
  <span class="s">{</span>
    <span class="i">$parameters</span> .= <span class="q">&quot;$arg $args{$arg} &quot;</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="k">my</span> <span class="i">$response</span> = <span class="q">qx/$args{MpsLib}$executable $parameters/</span><span class="sc">;</span>  
  <span class="i">acpa_cleanup</span><span class="s">(</span><span class="i">db_connect</span><span class="s">(</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">return</span> <span class="i">$response</span><span class="sc">;</span>
<span class="s">}</span>



</pre><p></p>
<h3><a name="test_no_alarm_condition">Test No Alarm Condition</a></h3>
<p>Tests Audit behavior when alarm condition is not present.</p>
<p>The Alarm condition in this audit is based on the 'alarm_threshold'
property.  By default it is set to 10 abends.  The first test sets up 
the environment with 16 abends, which exceeds the alarm threshold 
and causes a page.  
This test leverages the existing setup subroutines of Test 1 after 
increasing the threshold value above 16 abends, and then repeats Test 1. 
This is makes the number of abends less than the threshold value
and should not generate a page.</p>
<pre>
<a name="test2-"></a><span class="k">sub </span><span class="m">test2</span>
<span class="s">{</span>
  <span class="i">$args</span>{<span class="w">alarm_threshold</span>} = <span class="n">20</span><span class="sc">;</span>
  <span class="i">test1</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>


</pre><p></p>
<h3><a name="test_no_alarm_condition">Test No Alarm Condition</a></h3>
<p>Tests Audit behavior when alarm condition is not present.</p>
<p>The Alarm condition in this audit is based on the 'alarm_threshold'
property.  By default it is set to 10 abends.  The first test sets up 
the environment with 16 abends, which exceeds the alarm threshold 
and causes a page.  
This test leverages the existing setup subroutines of Test 1 after 
increasing the threshold value to exactly 16 abends, and then repeats Test 1. 
This tests that the threshold is inclusive and a number of abends in the system 
equaling exactly the threshold value should not generate a page.</p>
<pre>
<a name="test3-"></a><span class="k">sub </span><span class="m">test3</span>
<span class="s">{</span>
  <span class="i">$args</span>{<span class="w">alarm_threshold</span>} = <span class="n">16</span><span class="sc">;</span>
  <span class="i">test1</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>



</pre><p></p>
<h3><a name="supporting_subroutines">Supporting Subroutines</a></h3>
<p>These are general subroutines used for environment setup for tests, 
database connectivity and other miscellanea.</p>
<dl>
<dt><strong><a name="item_page">page</a></strong><br />
</dt>
<p>Analyzes the return value of a test.
Pages specified oncall pager and sends an email to a specified address
if the return value indicates an Alarm Condition.</p>
<pre>
<a name="page-"></a><span class="k">sub </span><span class="m">page</span>
<span class="s">{</span>
  <span class="k">my</span> <span class="i">$data</span> = <span class="k">shift</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$subject</span> = <span class="i">$args</span>{<span class="w">title</span>}<span class="sc">;</span>
  
  <span class="k">print</span> <span class="q">&quot;\nAudit result is:\n$data\n&quot;</span><span class="sc">;</span>
  <span class="k">if</span><span class="s">(</span><span class="i">$data</span> <span class="k">eq</span> <span class="q">&quot;Nothing Found!\n&quot;</span><span class="s">)</span>
  <span class="s">{</span>
    <span class="k">print</span> <span class="q">&quot;Not an alarm condition.\nNot paging oncall.\n&quot;</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="k">elsif</span><span class="s">(</span>! <span class="k">defined</span> <span class="i">$data</span><span class="s">)</span>
  <span class="s">{</span>
    <span class="k">print</span> <span class="q">&quot;Error has occurred.  No data received from Audit.\n&quot;</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="k">else</span>
  <span class="s">{</span>
    <span class="k">print</span> <span class="q">&quot;Paging Oncall\n&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$msg</span> = <span class="w">MIME::Lite</span><span class="w">-&gt;new</span><span class="s">(</span>
                <span class="w">From</span>    <span class="cm">=&gt;</span> <span class="q">'MPS Monitor'</span><span class="cm">,</span>
                <span class="w">To</span>      <span class="cm">=&gt;</span> <span class="i">$email</span><span class="cm">,</span>
                <span class="w">CC</span>      <span class="cm">=&gt;</span> <span class="i">$pager</span><span class="cm">,</span>
                <span class="w">Subject</span> <span class="cm">=&gt;</span> <span class="i">$subject</span><span class="cm">,</span>
                <span class="w">Data</span>    <span class="cm">=&gt;</span> <span class="i">$data</span>
              <span class="s">)</span><span class="sc">;</span>

    <span class="i">$msg</span><span class="i">-&gt;send</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="s">}</span>
<span class="s">}</span>


</pre><dt><strong><a name="item_env_setup">env_setup</a></strong><br /></dt>
<p>Reads the XML config file.
Stores configuration parameters into a hash.
Set up the environment for running string tests.
Returns a reference to the configuration hash.</p>
<pre>
<a name="env_setup-"></a><span class="k">sub </span><span class="m">env_setup</span>
<span class="s">{</span>
  <span class="c"># Use configuration file provided on the command line if it exists.</span>
  <span class="c"># Otherwise use standard config.xml</span>
  <span class="k">my</span> <span class="i">$config_file</span><span class="sc">;</span>
  <span class="s">{</span>
    <span class="k">no</span> <span class="w">warnings</span><span class="sc">;</span>  <span class="c"># to prevent warning if $ARGV[0] is not defined, which is valid.</span>
    <span class="i">$config_file</span> = <span class="i">$ARGV</span>[<span class="n">0</span>]<span class="sc">;</span>
  <span class="s">}</span>

  <span class="k">unless</span><span class="s">(</span><span class="k">defined</span> <span class="i">$config_file</span><span class="s">)</span>
  <span class="s">{</span>
    <span class="i">$config_file</span> = <span class="q">'MafAbends.xml'</span><span class="sc">;</span>
  <span class="s">}</span>

  <span class="k">unless</span><span class="s">(</span> <span class="k">-f</span> <span class="i">$config_file</span> <span class="s">)</span>
  <span class="s">{</span>
    <span class="w">croak</span> <span class="q">&quot;Unable to find configuration file.\n$!&quot;</span><span class="sc">;</span>
  <span class="s">}</span>

  <span class="k">my</span> <span class="i">$config</span> = <span class="w">XML::Simple</span><span class="w">-&gt;new</span><span class="s">(</span><span class="s">)</span><span class="i">-&gt;XMLin</span><span class="s">(</span><span class="i">$config_file</span><span class="s">)</span><span class="sc">;</span>

  <span class="c"># set up environment variables</span>
  <span class="k">foreach</span> <span class="k">my</span> <span class="i">$env</span> <span class="s">(</span><span class="k">keys</span><span class="s">(</span><span class="i">%</span>{<span class="i">$config</span>-&gt;{<span class="w">env_vars</span>}}<span class="s">)</span><span class="s">)</span>
  <span class="s">{</span>
    <span class="i">$ENV</span>{<span class="i">$env</span>} = <span class="i">$config</span>-&gt;{<span class="w">env_vars</span>}-&gt;{<span class="i">$env</span>}<span class="sc">;</span>
  <span class="s">}</span>
  <span class="k">return</span> <span class="i">$config</span><span class="sc">;</span>
<span class="s">}</span>


</pre><dt><strong><a name="item_db_setup_for_test1">db_setup_for_test1</a></strong><br /></dt>
<p>Sets up the database for the first string test.
The AC_PROCESSING_ACCOUNTING table is cleared, then populated
with 16 MAF Abends, which signifies an Alarm Condition.</p>
<pre>
<a name="db_setup_for_test1-"></a><span class="k">sub </span><span class="m">db_setup_for_test1</span>
<span class="s">{</span>
  <span class="k">my</span> <span class="i">$uscdb</span> = <span class="i">db_connect</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">acpa_cleanup</span><span class="s">(</span><span class="i">$uscdb</span><span class="s">)</span><span class="sc">;</span>
  
  <span class="k">my</span> <span class="i">$file</span> = <span class="i">$args</span>{<span class="w">MpsLib</span>} . <span class="q">'/test_data/get_counts_inserts.sql'</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">@insert_stmt</span> = <span class="i">get_insert_statements</span><span class="s">(</span><span class="i">$file</span><span class="s">)</span><span class="sc">;</span>
  
  <span class="c"># insert into ac_processing_accounting</span>
  <span class="k">foreach</span> <span class="k">my</span> <span class="i">$insert_sql</span> <span class="s">(</span><span class="i">@insert_stmt</span><span class="s">)</span>
  <span class="s">{</span>
    <span class="k">my</span> <span class="i">$rc</span> = <span class="i">$uscdb</span><span class="i">-&gt;setQuery</span><span class="s">(</span><span class="i">$insert_sql</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">unless</span><span class="s">(</span><span class="k">defined</span> <span class="i">$rc</span><span class="s">)</span>
    <span class="s">{</span>
      <span class="i">$uscdb</span><span class="i">-&gt;closeConnection</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
      <span class="w">croak</span> <span class="q">&quot;Error setting Query\n&quot;</span> . <span class="i">$uscdb</span><span class="i">-&gt;displayError</span><span class="s">(</span><span class="s">)</span> . <span class="q">&quot;$!\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">$rc</span> = <span class="i">$uscdb</span><span class="i">-&gt;runQuery</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">unless</span><span class="s">(</span><span class="k">defined</span> <span class="i">$rc</span><span class="s">)</span>
    <span class="s">{</span>
      <span class="i">$uscdb</span><span class="i">-&gt;closeConnection</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
      <span class="w">croak</span> <span class="q">&quot;Error running Query\n&quot;</span> . <span class="i">$uscdb</span><span class="i">-&gt;displayError</span><span class="s">(</span><span class="s">)</span> . <span class="q">&quot;$!\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
  <span class="s">}</span>
  <span class="i">$uscdb</span><span class="i">-&gt;commit</span><span class="sc">;</span>
  <span class="i">$uscdb</span><span class="i">-&gt;closeConnection</span><span class="sc">;</span>
<span class="s">}</span>


</pre><dt><strong><a name="item_acpa_cleanup">acpa_cleanup</a></strong><br /></dt>
<p>Clears the AC_PROCESSING_ACCOUNTING table.</p>
<pre>
<a name="acpa_cleanup-"></a><span class="k">sub </span><span class="m">acpa_cleanup</span>
<span class="s">{</span>
  <span class="k">my</span> <span class="i">$uscdb</span> = <span class="i">$_</span>[<span class="n">0</span>]<span class="sc">;</span>
  
  <span class="k">unless</span><span class="s">(</span><span class="k">defined</span> <span class="i">$uscdb</span><span class="s">)</span>
  <span class="s">{</span>
    <span class="i">$uscdb</span> = <span class="i">db_connect</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="k">my</span> <span class="i">$cleanup_sql</span> = <span class="q">'DELETE FROM AC_PROCESSING_ACCOUNTING'</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$rc</span> = <span class="i">$uscdb</span><span class="i">-&gt;setQuery</span><span class="s">(</span><span class="i">$cleanup_sql</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">unless</span><span class="s">(</span><span class="k">defined</span> <span class="i">$rc</span><span class="s">)</span>
  <span class="s">{</span>
    <span class="i">$uscdb</span><span class="i">-&gt;closeConnection</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="w">croak</span> <span class="i">$uscdb</span><span class="i">-&gt;displayError</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="q">&quot;$!\n&quot;</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="i">$uscdb</span><span class="i">-&gt;runQuery</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">unless</span><span class="s">(</span><span class="k">defined</span> <span class="i">$rc</span><span class="s">)</span>
  <span class="s">{</span>
    <span class="i">$uscdb</span><span class="i">-&gt;closeConnection</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="w">croak</span> <span class="i">$uscdb</span><span class="i">-&gt;displayError</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="q">&quot;$!\n&quot;</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="i">$uscdb</span><span class="i">-&gt;commit</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  
  <span class="c"># disconnect if using your own handle.</span>
  <span class="k">unless</span><span class="s">(</span><span class="k">defined</span> <span class="i">$_</span>[<span class="n">0</span>]<span class="s">)</span>
  <span class="s">{</span>
    <span class="i">$uscdb</span><span class="i">-&gt;closeConnection</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="s">}</span>
<span class="s">}</span>


</pre><dt><strong><a name="item_db_connect">db_connect</a></strong><br /></dt>
<p>Connects to the database.
Returns reference to the database handle object.</p>
<pre>
<a name="db_connect-"></a><span class="k">sub </span><span class="m">db_connect</span>
<span class="s">{</span>
  <span class="k">my</span> <span class="i">$uscdb</span>       = <span class="w">USCDB</span><span class="w">-&gt;new</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">@connect_str</span> =
    <span class="i">$uscdb</span><span class="i">-&gt;getDBParmsfromOper</span><span class="s">(</span><span class="i">$args</span>{<span class="w">op_job</span>}<span class="cm">,</span>  <span class="i">$args</span>{<span class="w">op_sid</span>}<span class="cm">,</span>
                               <span class="i">$args</span>{<span class="w">op_user</span>}<span class="cm">,</span> <span class="i">$args</span>{<span class="w">op_pass</span>}<span class="s">)</span><span class="sc">;</span>

  <span class="c"># Get rid of white space in the parameter values.</span>
  <span class="k">foreach</span> <span class="k">my</span> <span class="i">$conn</span> <span class="s">(</span><span class="i">@connect_str</span><span class="s">)</span>
  <span class="s">{</span>
      <span class="i">$conn</span> =~ <span class="q">s/\s+//g</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="k">my</span> <span class="i">$rc</span> = <span class="i">$uscdb</span><span class="i">-&gt;openConnection</span><span class="s">(</span><span class="i">@connect_str</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">unless</span> <span class="s">(</span><span class="k">defined</span> <span class="i">$rc</span><span class="s">)</span>
  <span class="s">{</span>
      <span class="w">carp</span> <span class="q">&quot;Could not connect to Oracle!&quot;</span><span class="cm">,</span> <span class="i">$uscdb</span><span class="i">-&gt;getErrorStr</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="q">&quot;\n\n&quot;</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="k">return</span> <span class="i">$uscdb</span><span class="sc">;</span>
<span class="s">}</span>


</pre><dt><strong><a name="item_get_insert_statements">get_insert_statements</a></strong><br /></dt>
<p>Returns an array of SQL statements from a file.</p>
</dl>

<pre>
<a name="get_insert_statements-"></a><span class="k">sub </span><span class="m">get_insert_statements</span>
<span class="s">{</span>
  <span class="k">my</span> <span class="i">$file</span> = <span class="k">shift</span><span class="sc">;</span>
  
  <span class="k">open</span><span class="s">(</span><span class="w">FH</span><span class="cm">,</span><span class="i">$file</span><span class="s">)</span> <span class="k">or</span> <span class="w">croak</span> <span class="q">&quot;Unable to open $file\n&quot;</span>
                        . <span class="q">'Make sure you checked it out from PVCS'</span>
                        . <span class="q">'subproject /ora/vmdb/mps/Monitor/test_data/'</span>
                        . <span class="q">&quot;$!&quot;</span><span class="sc">;</span>
  
  <span class="c"># this slurps insert statements into array</span>
  <span class="k">my</span> <span class="i">@insert_stmt</span> = <span class="k">do</span> <span class="s">{</span> <span class="k">local</span><span class="s">(</span> <span class="i">$/</span> = <span class="q">';'</span> <span class="s">)</span> <span class="sc">;</span> <span class="q">&lt;FH&gt;</span> <span class="s">}</span> <span class="sc">;</span>
  <span class="k">pop</span> <span class="i">@insert_stmt</span><span class="sc">;</span> <span class="c"># remove empty element after the last ';'</span>
  <span class="k">foreach</span> <span class="s">(</span><span class="i">@insert_stmt</span><span class="s">)</span>
  <span class="s">{</span>
    <span class="k">chop</span><span class="sc">;</span> <span class="c"># remove the ';' char</span>
    <span class="q">s/(\n\n|\n$)//</span><span class="sc">;</span> <span class="c"># remove blank lines</span>
  <span class="s">}</span>
  
  <span class="k">return</span> <span class="i">@insert_stmt</span><span class="sc">;</span>
<span class="s">}</span>
<a name="EOF-"></a></pre></body>

</html>
