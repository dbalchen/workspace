<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>MafMonitor.t</title>
<link rev="made" href="mailto:" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>MafMonitor.t</h1>

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<ul>

		<li><a href="#mafmonitor_unit_test_suite_">MafMonitor Unit Test Suite. </a></li>
		<ul>

			<li><a href="#synopsis">SYNOPSIS</a></li>
			<li><a href="#description">DESCRIPTION</a></li>
			<li><a href="#input_parameters">INPUT PARAMETERS</a></li>
			<li><a href="#tests">TESTS</a></li>
			<li><a href="#test_monitor">Test Monitor</a></li>
			<li><a href="#test_monitor__mafmonitor">Test Monitor::MafMonitor</a></li>
			<li><a href="#test_inheritance">Test Inheritance</a></li>
			<li><a href="#test_get_market__">Test <code>get_market()</code></a></li>
			<li><a href="#test_get_mpslib__">Test <code>get_MpsLib()</code></a></li>
			<li><a href="#test_get_maf_port__">Test <code>get_maf_port()</code></a></li>
			<li><a href="#test_run_check__">Test <code>run_check()</code></a></li>
			<li><a href="#test_error_condition">Test error condition</a></li>
			<li><a href="#env_update">env_update</a></li>
			<li><a href="#env_login__"><code>env_login()</code></a></li>
			<li><a href="#stop_maf__"><code>stop_maf()</code></a></li>
			<li><a href="#start_maf__"><code>start_maf()</code></a></li>
			<li><a href="#update_port__"><code>update_port()</code></a></li>
			<li><a href="#disconnect__"><code>disconnect()</code></a></li>
		</ul>

	</ul>

</ul>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#env_update-">package main</a>
<ul>
<li><a href="#env_update-">env_update</a></li>
<li><a href="#env_login-">env_login</a></li>
<li><a href="#stop_maf-">stop_maf</a></li>
<li><a href="#start_maf-">start_maf</a></li>
<li><a href="#update_port-">update_port</a></li>
<li><a href="#disconnect-">disconnect</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<hr />
<pre>#!/opt/perl5/bin/perl

</pre><p></p>
<h2><a name="mafmonitor_unit_test_suite_">MafMonitor Unit Test Suite.</a></h2>
<pre>

=head3 AUTHOR</pre>
<p>Pete Chudykowski</p>
<p>
</p>
<h3><a name="synopsis">SYNOPSIS</a></h3>
<pre>
  perl MafMonitor.t MpsLib &lt;path&gt; market &lt;M0X&gt; host &lt;host/ip&gt;
                    usr &lt;usr&gt; passwd &lt;password&gt; remote_port_file &lt;file&gt;</pre>
<p>
</p>
<h3><a name="description">DESCRIPTION</a></h3>
<pre>
  Tests basic functionality of the MafMonitor class.</pre>
<p>
</p>
<h3><a name="input_parameters">INPUT PARAMETERS</a></h3>
<pre>
  The input parameters comprise of the following pairs:
  Key:          Value:    Description:
  MpsLib        &lt;path&gt;    Attribute of monitor.xml &lt;M0X&gt; tab.
  market        &lt;M0X&gt;     Attribute of monitor.xml &lt;params&gt; tab.
  host          &lt;host/ip&gt; Domain name or IP of the test environment host.
  usr           &lt;user&gt;    User name of the test environment account.
  passwd        &lt;passwd&gt;  Password to the test environment account.
  remote_port_file
                &lt;file&gt;    Path and name of the port file in the test
                          environment.</pre>
<pre>
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">warnings</span><span class="sc">;</span>

<span class="k">BEGIN</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">@ARGV</span><span class="sc">;</span>
    <span class="k">push</span> <span class="i">@INC</span><span class="cm">,</span> <span class="i">$args</span>{<span class="w">MpsLib</span>}<span class="sc">;</span>
<span class="s">}</span>

<span class="k">use</span> <span class="w">Test::More</span> <span class="q">'no_plan'</span><span class="sc">;</span>    <span class="c"># you can replace the 'no_plan' with (tests=&gt;n)</span>
                             <span class="c"># where n is the number of tests in the suite.</span>
<span class="k">use</span> <span class="w">Net::Telnet</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Carp</span><span class="sc">;</span>

<span class="i">$|</span> = <span class="n">1</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">%args</span> = <span class="i">@ARGV</span><span class="sc">;</span>

<span class="i">env_update</span><span class="s">(</span><span class="i">$args</span>{<span class="w">host</span>}<span class="cm">,</span> <span class="i">$args</span>{<span class="w">usr</span>}<span class="cm">,</span> <span class="i">$args</span>{<span class="w">passwd</span>}<span class="cm">,</span> <span class="i">$args</span>{<span class="w">remote_maf_port</span>}<span class="s">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="tests">TESTS</a></h3>
<p>
</p>
<h3><a name="test_monitor">Test Monitor</a></h3>
<pre>
  Verifies that the Monitor module is visible and accessible.</pre>
<pre>
<span class="i">use_ok</span><span class="s">(</span><span class="q">'Monitor'</span><span class="s">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="test_monitor__mafmonitor">Test Monitor::MafMonitor</a></h3>
<pre>
  Verifies that the MafMonitor module is visible and accessible.</pre>
<pre>
<span class="i">use_ok</span><span class="s">(</span><span class="q">'Monitor::MafMonitor'</span><span class="s">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="test_inheritance">Test Inheritance</a></h3>
<pre>
  Verifies that MafMonitor is a sub class of Monitor.</pre>
<pre>
<span class="k">my</span> <span class="i">$maf_monitor</span> = <span class="w">Monitor::MafMonitor</span><span class="w">-&gt;new</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span><span class="sc">;</span>

<span class="i">ok</span><span class="s">(</span><span class="i">$maf_monitor</span><span class="i">-&gt;isa</span><span class="s">(</span><span class="q">'Monitor::MafMonitor'</span><span class="s">)</span><span class="cm">,</span>
    <span class="q">&quot;Object is of type Monitor::MafMonitor&quot;</span><span class="s">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="test_get_market__">Test <code>get_market()</code></a></h3>
<pre>
  Test accessor method get_market().</pre>
<pre>
<span class="i">is</span><span class="s">(</span><span class="k">uc</span><span class="s">(</span><span class="i">$maf_monitor</span><span class="i">-&gt;get_market</span><span class="s">(</span><span class="s">)</span><span class="s">)</span><span class="cm">,</span>
    <span class="q">'M01'</span><span class="cm">,</span> <span class="q">&quot;Object is set up for the correct market&quot;</span><span class="s">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="test_get_mpslib__">Test <code>get_MpsLib()</code></a></h3>
<pre>
  Test accessor method get_MpsLib().</pre>
<pre>
<span class="i">is</span><span class="s">(</span><span class="i">$maf_monitor</span><span class="i">-&gt;get_MpsLib</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="i">$args</span>{<span class="w">MpsLib</span>}<span class="cm">,</span> <span class="q">&quot;MpsLib is set correctly&quot;</span><span class="s">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="test_get_maf_port__">Test <code>get_maf_port()</code></a></h3>
<pre>
  Test method get_maf_port().</pre>
<pre>
<span class="i">ok</span><span class="s">(</span><span class="i">$maf_monitor</span><span class="i">-&gt;get_maf_port</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="q">&quot;get_maf_port() returns a defined value&quot;</span><span class="s">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="test_run_check__">Test <code>run_check()</code></a></h3>
<pre>
  Verify that run_check() returns the expected string
  when the Monitor is up..</pre>
<pre>
<span class="i">env_update</span><span class="s">(</span><span class="i">$args</span>{<span class="w">host</span>}<span class="cm">,</span> <span class="i">$args</span>{<span class="w">usr</span>}<span class="cm">,</span> <span class="i">$args</span>{<span class="w">passwd</span>}<span class="cm">,</span> <span class="i">$args</span>{<span class="w">remote_maf_port</span>}<span class="s">)</span><span class="sc">;</span>

<span class="c"># get a new instance of $MafMonitor</span>
<span class="i">$maf_monitor</span> = <span class="w">Monitor::MafMonitor</span><span class="w">-&gt;new</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$return_str</span> = <span class="i">$maf_monitor</span><span class="i">-&gt;run_check</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="i">is</span><span class="s">(</span><span class="i">$return_str</span><span class="cm">,</span>
    <span class="q">&quot;Maf monitor is UP.&quot;</span><span class="cm">,</span>
    <span class="q">'run_check() returns expected value when monitor is up'</span><span class="s">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="test_error_condition">Test error condition</a></h3>
<pre>
  Verify that run_check reports correctly when Maf Listener is down.</pre>
<pre>
<span class="k">my</span> <span class="i">$t</span> = <span class="i">env_login</span><span class="s">(</span><span class="i">$args</span>{<span class="w">host</span>}<span class="cm">,</span> <span class="i">$args</span>{<span class="w">usr</span>}<span class="cm">,</span> <span class="i">$args</span>{<span class="w">passwd</span>}<span class="s">)</span><span class="sc">;</span>
<span class="i">stop_maf</span><span class="s">(</span><span class="i">$t</span><span class="s">)</span><span class="sc">;</span>
<span class="i">update_port</span><span class="s">(</span><span class="i">$t</span><span class="cm">,</span> <span class="i">$args</span>{<span class="w">remote_maf_port</span>}<span class="s">)</span><span class="sc">;</span>

<span class="c"># get a new instance of MafMonitor</span>
<span class="i">$maf_monitor</span> = <span class="w">Monitor::MafMonitor</span><span class="w">-&gt;new</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span><span class="sc">;</span>
<span class="i">$return_str</span>  = <span class="i">$maf_monitor</span><span class="i">-&gt;run_check</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="i">is</span><span class="s">(</span><span class="i">$return_str</span><span class="cm">,</span>
    <span class="q">&quot;Maf monitor is DOWN!&quot;</span><span class="cm">,</span>
    <span class="q">'run_check() returns expected value when monitor is down'</span><span class="s">)</span><span class="sc">;</span>
<span class="i">disconnect</span><span class="s">(</span><span class="i">$t</span><span class="s">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="env_update">env_update</a></h3>
<pre>
    Telnet into the testing environment.
    Stop Maf.
    Start Maf.
    Update MafPort.txt with the new port.</pre>
<pre>
<a name="env_update-"></a><span class="k">sub </span><span class="m">env_update</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$host</span><span class="cm">,</span> <span class="i">$usr</span><span class="cm">,</span> <span class="i">$passwd</span><span class="cm">,</span> <span class="i">$port_file</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;Setting up test environment $usr on $host.\n&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$t</span> = <span class="i">env_login</span><span class="s">(</span><span class="i">$host</span><span class="cm">,</span> <span class="i">$usr</span><span class="cm">,</span> <span class="i">$passwd</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">stop_maf</span><span class="s">(</span><span class="i">$t</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">start_maf</span><span class="s">(</span><span class="i">$t</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">update_port</span><span class="s">(</span><span class="i">$t</span><span class="cm">,</span> <span class="i">$port_file</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">disconnect</span><span class="s">(</span><span class="i">$t</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="env_login__"><code>env_login()</code></a></h3>
<pre>
    Telnet into the testing environment.
    Takes:  host
            username
            password 
    Return telnet handle.</pre>
<pre>
<a name="env_login-"></a><span class="k">sub </span><span class="m">env_login</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$host</span><span class="cm">,</span> <span class="i">$usr</span><span class="cm">,</span> <span class="i">$passwd</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$t</span> = <span class="w">Net::Telnet</span><span class="w">-&gt;new</span><span class="s">(</span><span class="w">Timeout</span> <span class="cm">=&gt;</span> <span class="n">120</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;connecting   ... &quot;</span><span class="sc">;</span>
    <span class="i">$t</span><span class="i">-&gt;open</span><span class="s">(</span><span class="i">$host</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;done.\nlogging in   ... &quot;</span><span class="sc">;</span>
    <span class="i">$t</span><span class="i">-&gt;login</span><span class="s">(</span><span class="i">$usr</span><span class="cm">,</span> <span class="i">$passwd</span><span class="s">)</span> <span class="k">or</span> <span class="w">croak</span> <span class="q">&quot;Unable to log in to $host\n&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;done.\n&quot;</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$t</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="stop_maf__"><code>stop_maf()</code></a></h3>
<pre>
    Stop Maf.
    Takes: telnet handle.</pre>
<pre>
<a name="stop_maf-"></a><span class="k">sub </span><span class="m">stop_maf</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="i">$t</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;stopping maf ... &quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@lines</span> = <span class="i">$t</span><span class="i">-&gt;cmd</span><span class="s">(</span><span class="q">&quot;mps_lsn_stop_sh&quot;</span><span class="s">)</span><span class="sc">;</span>

    <span class="c">#    print @lines, &quot;\n\n&quot;;</span>
    <span class="k">sleep</span> <span class="n">30</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;done.\n&quot;</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="start_maf__"><code>start_maf()</code></a></h3>
<pre>
    Start Maf.
    Takes: telnet handle.</pre>
<pre>
<a name="start_maf-"></a><span class="k">sub </span><span class="m">start_maf</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="i">$t</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;starting maf ... &quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@lines</span> = <span class="i">$t</span><span class="i">-&gt;cmd</span><span class="s">(</span><span class="q">&quot;mps_lsn_sh&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;done.\n&quot;</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="update_port__"><code>update_port()</code></a></h3>
<pre>
    Update MafPort.txt with the new port.
    Takes: telnet handle.</pre>
<pre>
<a name="update_port-"></a><span class="k">sub </span><span class="m">update_port</span>    
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$t</span><span class="cm">,</span> <span class="i">$remote_port_file</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@port</span> = <span class="i">$t</span><span class="i">-&gt;cmd</span><span class="s">(</span><span class="q">&quot;cat $remote_port_file&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">for</span> <span class="s">(</span><span class="i">@port</span><span class="s">)</span>
    <span class="s">{</span>
        <span class="k">chomp</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="q">/PORT/</span><span class="s">)</span>
        <span class="s">{</span>
            <span class="k">open</span><span class="s">(</span><span class="w">PORT_FILE</span><span class="cm">,</span> <span class="q">&quot;&gt;$args{maf_port}&quot;</span><span class="s">)</span>
              <span class="k">or</span> <span class="w">croak</span> <span class="q">&quot;unable to open $args{maf_port} for writing!\n&quot;</span><span class="sc">;</span>
            <span class="k">print</span> <span class="i">PORT_FILE</span> <span class="i">$_</span><span class="sc">;</span>
            <span class="k">close</span><span class="s">(</span><span class="w">PORT_FILE</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">last</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">else</span>
        <span class="s">{</span>
            <span class="k">unlink</span> <span class="i">$args</span>{<span class="w">maf_port</span>}<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="disconnect__"><code>disconnect()</code></a></h3>
<pre>
    Disconnect from the telnet session.</pre>

<pre>
<a name="disconnect-"></a><span class="k">sub </span><span class="m">disconnect</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="i">$t</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;disconnecting ... &quot;</span><span class="sc">;</span>
    <span class="i">$t</span><span class="i">-&gt;close</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;done.\n&quot;</span><span class="sc">;</span>
<span class="s">}</span>

<a name="EOF-"></a></pre></body>

</html>
