<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>MafAbends.t</title>
<link rev="made" href="mailto:" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>MafAbends.t</h1>

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<ul>

		<li><a href="#mafabends_unit_test_suite_">MafAbends Unit Test Suite.</a></li>
		<ul>

			<li><a href="#author">AUTHOR</a></li>
			<li><a href="#synopsis">SYNOPSIS</a></li>
			<li><a href="#description">DESCRIPTION</a></li>
			<li><a href="#input_parameters">INPUT PARAMETERS</a></li>
			<li><a href="#test_mafabends">Test MafAbends</a></li>
			<li><a href="#test_monitor">Test Monitor</a></li>
			<li><a href="#test_inheritance">Test Inheritance</a></li>
			<li><a href="#test_accessor_methods">Test Accessor Methods</a></li>
			<li><a href="#test_audit_methods">Test Audit methods</a></li>
			<li><a href="#supporting_subroutines">Supporting Subroutines</a></li>
		</ul>

	</ul>

</ul>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#get_object-">package main</a>
<ul>
<li><a href="#get_object-">get_object</a></li>
<li><a href="#db_setup_for_get_counts-">db_setup_for_get_counts</a></li>
<li><a href="#db_setup_for_run_check_alarm_condition-">db_setup_for_run_check_alarm_condition</a></li>
<li><a href="#db_setup_for_run_check_nothing_found-">db_setup_for_run_check_nothing_found</a></li>
<li><a href="#db_connect-">db_connect</a></li>
<li><a href="#acpa_cleanup-">acpa_cleanup</a></li>
<li><a href="#get_insert_statements-">get_insert_statements</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<hr />
<p>
</p>
<h2><a name="mafabends_unit_test_suite_">MafAbends Unit Test Suite.</a></h2>
<p>
</p>
<h3><a name="author">AUTHOR</a></h3>
<p>Pete Chudykowski</p>
<p>
</p>
<h3><a name="synopsis">SYNOPSIS</a></h3>
<pre>
  perl MafAbends.t MpsLib &lt;path&gt; 
                   SqlLib &lt;path&gt; 
                   Log &lt;path&gt;
                   sql_query &lt;file&gt;
                   alarm_threshold &lt;int hours&gt;  
                   market &lt;M0X&gt; 
                   title &lt;string&gt;
                   [op_job &lt;job&gt;] 
                   [op_sid &lt;db instance&gt;]
                   [op_user &lt;username&gt;] 
                   [op_pass &lt;password&gt;]</pre>
<p>
</p>
<h3><a name="description">DESCRIPTION</a></h3>
<p>Tests basic functionality of the MafAbends class.</p>
<p>
</p>
<h3><a name="input_parameters">INPUT PARAMETERS</a></h3>
<p>The input parameters comprise of the following pairs:</p>
<pre>
 Key:          Value:    Description:
 MpsLib        &lt;path&gt;    Attribute of monitor.xml &lt;M0X&gt; tab.
 SqlLib        &lt;path&gt;    Attribute of monitor.xml &lt;M0X&gt; tab.
 Log           &lt;path&gt;    Attribute of monitor.xml &lt;params&gt; tab.
 alarm_threshold &lt;hours&gt; Attribute of monitor.xml &lt;params&gt; tab.
 sql_query     &lt;file&gt;    Attribute of monitor.xml &lt;params&gt; tab.
 market        &lt;M0X&gt;     Attribute of monitor.xml &lt;params&gt; tab.</pre>
<pre>
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">warnings</span><span class="sc">;</span>

<span class="k">BEGIN</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">@ARGV</span><span class="sc">;</span>
    <span class="k">push</span> <span class="i">@INC</span><span class="cm">,</span> <span class="i">$args</span>{<span class="w">MpsLib</span>}<span class="sc">;</span>
<span class="s">}</span>

<span class="k">use</span> <span class="w">Test::More</span> <span class="w">tests</span> <span class="cm">=&gt;</span> <span class="n">22</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">USCDB</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Carp</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Data::Dumper</span><span class="sc">;</span>

<span class="i">$|</span> = <span class="n">1</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">%args</span> = <span class="i">@ARGV</span><span class="sc">;</span>


</pre><p></p>
<h3><a name="test_mafabends">Test MafAbends</a></h3>
<p>Verifies that MafAbends module exists, is in the path, 
and that it returns a true value.</p>
<pre>
<span class="i">use_ok</span><span class="s">(</span><span class="q">'Monitor::MafAbends'</span><span class="s">)</span><span class="sc">;</span>


</pre><p></p>
<h3><a name="test_monitor">Test Monitor</a></h3>
<p>Verifies that the Monitor module is visible and accessible.</p>
<pre>
<span class="i">use_ok</span><span class="s">(</span><span class="q">'Monitor'</span><span class="s">)</span><span class="sc">;</span>


</pre><p></p>
<h3><a name="test_inheritance">Test Inheritance</a></h3>
<p>Verifies that MafAbends is a subclass of Monitor.
Tests the constructor.</p>
<pre>
  <span class="k">my</span> <span class="i">$MafAbends</span> = <span class="i">get_object</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

  <span class="i">ok</span><span class="s">(</span><span class="i">$MafAbends</span><span class="i">-&gt;isa</span><span class="s">(</span><span class="q">'Monitor::MafAbends'</span><span class="s">)</span><span class="cm">,</span>
      <span class="q">&quot;Object is of type Monitor::MafAbends&quot;</span><span class="s">)</span><span class="sc">;</span>


</pre><p></p>
<h3><a name="test_accessor_methods">Test Accessor Methods</a></h3>
<dl>
<dt><strong><a name="item_create_a_new_mafabends_object_2e">Create a new MafAbends Object.</a></strong><br />
</dt>
<pre>
  <span class="i">$MafAbends</span> = <span class="i">get_object</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    

</pre><dt><strong><a name="item_mpslib_accessor_2e">MpsLib accessor.</a></strong><br /></dt>
<pre>
  <span class="k">my</span> <span class="i">$MpsLib</span> = <span class="i">$MafAbends</span><span class="i">-&gt;MpsLib</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">is</span><span class="s">(</span><span class="i">$MpsLib</span><span class="cm">,</span> <span class="i">$args</span>{<span class="w">MpsLib</span>}<span class="cm">,</span>
     <span class="q">'Getting MpsLib works correctly'</span><span class="s">)</span><span class="sc">;</span>

  <span class="i">$MpsLib</span> = <span class="i">$MafAbends</span><span class="i">-&gt;MpsLib</span><span class="s">(</span><span class="q">'/new/path/'</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">is</span><span class="s">(</span><span class="i">$MpsLib</span><span class="cm">,</span><span class="q">'/new/path/'</span><span class="cm">,</span>
     <span class="q">'Setting MpsLib works correctly'</span><span class="s">)</span><span class="sc">;</span>


</pre><dt><strong><a name="item_sqllib_accessor_2e">SqlLib accessor.</a></strong><br /></dt>
<pre>
  <span class="k">my</span> <span class="i">$SqlLib</span> = <span class="i">$MafAbends</span><span class="i">-&gt;SqlLib</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">is</span><span class="s">(</span><span class="i">$SqlLib</span><span class="cm">,</span> <span class="i">$args</span>{<span class="w">SqlLib</span>}<span class="cm">,</span>
     <span class="q">'Getting SqlLib works correctly'</span><span class="s">)</span><span class="sc">;</span>

  <span class="i">$SqlLib</span> = <span class="i">$MafAbends</span><span class="i">-&gt;SqlLib</span><span class="s">(</span><span class="q">'/new/path/'</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">is</span><span class="s">(</span><span class="i">$SqlLib</span><span class="cm">,</span><span class="q">'/new/path/'</span><span class="cm">,</span>
     <span class="q">'Setting SqlLib works correctly'</span><span class="s">)</span><span class="sc">;</span>


</pre><dt><strong><a name="item_market_accessor">market accessor</a></strong><br /></dt>
<pre>
  <span class="k">my</span> <span class="i">$market</span> = <span class="i">$MafAbends</span><span class="i">-&gt;market</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">is</span><span class="s">(</span><span class="i">$market</span><span class="cm">,</span> <span class="i">$args</span>{<span class="w">market</span>}<span class="cm">,</span>
     <span class="q">'Getting market works correctly'</span><span class="s">)</span><span class="sc">;</span>

  <span class="i">$market</span> = <span class="i">$MafAbends</span><span class="i">-&gt;market</span><span class="s">(</span><span class="q">'M02'</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">is</span><span class="s">(</span><span class="i">$market</span><span class="cm">,</span><span class="q">'M02'</span><span class="cm">,</span>
     <span class="q">'Setting market works correctly'</span><span class="s">)</span><span class="sc">;</span>


</pre><dt><strong><a name="item_alarm_threshold_accessor">alarm_threshold accessor</a></strong><br /></dt>
<pre>
  <span class="k">my</span> <span class="i">$alarm_threshold</span> = <span class="i">$MafAbends</span><span class="i">-&gt;alarm_threshold</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">is</span><span class="s">(</span><span class="i">$alarm_threshold</span><span class="cm">,</span> <span class="i">$args</span>{<span class="w">alarm_threshold</span>}<span class="cm">,</span>
     <span class="q">'Getting alarm_threshold works correctly'</span><span class="s">)</span><span class="sc">;</span>

  <span class="i">$alarm_threshold</span> = <span class="i">$MafAbends</span><span class="i">-&gt;alarm_threshold</span><span class="s">(</span><span class="q">'20'</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">is</span><span class="s">(</span><span class="i">$alarm_threshold</span><span class="cm">,</span><span class="q">'20'</span><span class="cm">,</span>
     <span class="q">'Setting alarm_threshold works correctly'</span><span class="s">)</span><span class="sc">;</span>


</pre><dt><strong><a name="item_title_accessor">title accessor</a></strong><br /></dt>
<pre>
  <span class="k">my</span> <span class="i">$title</span> = <span class="i">$MafAbends</span><span class="i">-&gt;title</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">is</span><span class="s">(</span><span class="i">$title</span><span class="cm">,</span> <span class="i">$args</span>{<span class="w">title</span>}<span class="cm">,</span>
     <span class="q">'Getting title works correctly'</span><span class="s">)</span><span class="sc">;</span>

  <span class="i">$title</span> = <span class="i">$MafAbends</span><span class="i">-&gt;title</span><span class="s">(</span><span class="q">'new title'</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">is</span><span class="s">(</span><span class="i">$title</span><span class="cm">,</span><span class="q">'new title'</span><span class="cm">,</span>
     <span class="q">'Setting title works correctly'</span><span class="s">)</span><span class="sc">;</span>


</pre><dt><strong><a name="item_sql_query_accessor">sql_query accessor</a></strong><br /></dt>
<pre>
  <span class="k">my</span> <span class="i">$sql_query</span> = <span class="i">$MafAbends</span><span class="i">-&gt;sql_query</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">is</span><span class="s">(</span><span class="i">$sql_query</span><span class="cm">,</span> <span class="i">$args</span>{<span class="w">sql_query</span>}<span class="cm">,</span>
     <span class="q">'Getting sql_query works correctly'</span><span class="s">)</span><span class="sc">;</span>

  <span class="i">$sql_query</span> = <span class="i">$MafAbends</span><span class="i">-&gt;sql_query</span><span class="s">(</span><span class="q">'NewSqlFileName'</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">is</span><span class="s">(</span><span class="i">$sql_query</span><span class="cm">,</span><span class="q">'NewSqlFileName'</span><span class="cm">,</span>
     <span class="q">'Setting sql_query works correctly'</span><span class="s">)</span><span class="sc">;</span>


</pre></dl><p>
</p>
<h3><a name="test_audit_methods">Test Audit methods</a></h3>
<dl>
<dt><strong><a name="item_get_sql_query">get_sql_query</a></strong><br />
</dt>
<p>Tests retrieval of the SQL statement from the sql file using the
method inherited from Monitor get_sql_query().</p>
<pre>
  <span class="i">$MafAbends</span> = <span class="i">get_object</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$sql_stmt</span> = <span class="i">$MafAbends</span><span class="i">-&gt;get_sql_query</span><span class="s">(</span>
                                            <span class="i">$MafAbends</span>-&gt;{<span class="w">SqlLib</span>} 
                                          . <span class="i">$MafAbends</span>-&gt;{<span class="w">sql_query</span>}
                                          <span class="s">)</span><span class="sc">;</span>
  
  <span class="i">ok</span><span class="s">(</span><span class="i">$sql_stmt</span><span class="cm">,</span> <span class="q">'$sql_stmt is defined'</span><span class="s">)</span><span class="sc">;</span>
  

</pre><dt><strong><a name="item_get_counts">get_counts</a></strong><br /></dt>
<p>Tests the retrieval of abend counts from the database.
Some initial setup of the database is performed.</p>
<pre>
  <span class="c"># set up the database for the get_data test</span>
  <span class="i">db_setup_for_get_counts</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  
  <span class="i">$MafAbends</span> = <span class="i">get_object</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">%counts</span> = <span class="i">$MafAbends</span><span class="i">-&gt;get_counts</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  
  <span class="c"># compare the counts somehow</span>
  <span class="k">foreach</span> <span class="k">my</span> <span class="i">$pgm_name</span> <span class="s">(</span><span class="k">values</span><span class="s">(</span><span class="i">%counts</span><span class="s">)</span><span class="s">)</span>
  <span class="s">{</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$count</span> <span class="s">(</span><span class="k">values</span><span class="s">(</span><span class="i">%$pgm_name</span><span class="s">)</span><span class="s">)</span>
    <span class="s">{</span>
      <span class="i">is</span><span class="s">(</span><span class="i">$count</span><span class="cm">,</span><span class="n">4</span><span class="cm">,</span><span class="q">'Count is correct'</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
  <span class="s">}</span>

<span class="c"># DEBUG: For visual verification</span>
<span class="c">#  foreach my $pgm_name (keys(%counts))</span>
<span class="c">#  {</span>
<span class="c">#    foreach my $fstatus ( keys( %{$counts{$pgm_name}} ))</span>
<span class="c">#    {</span>
<span class="c">#      print &quot;$pgm_name\t$fstatus\t&quot; . $counts{$pgm_name}{$fstatus} . &quot;\n&quot;;</span>
<span class="c">#    }</span>
<span class="c">#  }</span>
<span class="c"># END DEBUG</span>

  <span class="i">acpa_cleanup</span><span class="s">(</span><span class="i">db_connect</span><span class="s">(</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span>



</pre><dt><strong><a name="item_run_check_alarm_condition">run_check_alarm_condition</a></strong><br /></dt>
<p>Tests the main Audit method <code>run_check()</code> in an alarm condition.</p>
<pre>
  <span class="i">db_setup_for_run_check_alarm_condition</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">$MafAbends</span> = <span class="i">get_object</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$run_check_result</span> = <span class="i">$MafAbends</span><span class="i">-&gt;run_check</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  
  <span class="k">my</span> <span class="i">$run_check_expected</span> = <span class="q">&quot;Main_Driver\tAE\t4\nMain_Driver\tAF\t4\n&quot;</span>
                         . <span class="q">&quot;Collections\tAE\t4\nCollections\tAF\t4\n&quot;</span><span class="sc">;</span>
  <span class="i">is</span><span class="s">(</span><span class="i">$run_check_result</span><span class="cm">,</span><span class="i">$run_check_expected</span><span class="cm">,</span>
     <span class="q">'run_check() produces expected result in the alarm condition'</span><span class="s">)</span><span class="sc">;</span>

  <span class="i">acpa_cleanup</span><span class="s">(</span><span class="i">db_connect</span><span class="s">(</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span>



</pre><dt><strong><a name="item_run_check_nothing_found">run_check_nothing_found</a></strong><br /></dt>
<p>Tests the main Audit method <code>run_check()</code> without an alarm condition.</p>
<pre>
  <span class="i">db_setup_for_run_check_nothing_found</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">$MafAbends</span> = <span class="i">get_object</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">$run_check_result</span> = <span class="i">$MafAbends</span><span class="i">-&gt;run_check</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  
  <span class="i">is</span><span class="s">(</span><span class="i">$run_check_result</span><span class="cm">,</span><span class="k">undef</span><span class="cm">,</span>
     <span class="q">'run_check() produces expected result without the alarm condition'</span><span class="s">)</span><span class="sc">;</span>

  <span class="i">acpa_cleanup</span><span class="s">(</span><span class="i">db_connect</span><span class="s">(</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span>


</pre></dl><p>
</p>
<h3><a name="supporting_subroutines">Supporting Subroutines</a></h3>
<dl>
<dt><strong><a name="item_getobject">getObject</a></strong><br />
</dt>
<p>Instanciates a MafAbends object useing input argument hash.
Returns a reference to this object.</p>
<pre>

<a name="get_object-"></a><span class="k">sub </span><span class="m">get_object</span>
<span class="s">{</span>
  <span class="k">return</span> <span class="w">Monitor::MafAbends</span><span class="w">-&gt;new</span><span class="s">(</span>
                            <span class="w">MpsLib</span>    <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">MpsLib</span>}<span class="cm">,</span>
                            <span class="w">SqlLib</span>    <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">SqlLib</span>}<span class="cm">,</span>
                            <span class="w">market</span>    <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">market</span>}<span class="cm">,</span>
                            <span class="w">alarm_threshold</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">alarm_threshold</span>}<span class="cm">,</span>         
                            <span class="w">title</span>     <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">title</span>}<span class="cm">,</span>
                            <span class="w">sql_query</span> <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">sql_query</span>}<span class="cm">,</span>
                            <span class="w">op_job</span>    <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">op_job</span>}<span class="cm">,</span>
                            <span class="w">op_sid</span>    <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">op_sid</span>}<span class="cm">,</span>
                            <span class="w">op_user</span>   <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">op_user</span>}<span class="cm">,</span>
                            <span class="w">op_pass</span>   <span class="cm">=&gt;</span> <span class="i">$args</span>{<span class="w">op_pass</span>}
                            <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>


</pre><dt><strong><a name="item_db_setup_for_get_counts">db_setup_for_get_counts</a></strong><br /></dt>
<p>Sets up the ac_processing accounting for the get_counts test.
Cleans up ac_processing_accounting in case something got left over.
Inserts some rows of Collections and Main Driver AF's an AE's.</p>
<pre>
<a name="db_setup_for_get_counts-"></a><span class="k">sub </span><span class="m">db_setup_for_get_counts</span>
<span class="s">{</span>
  <span class="k">my</span> <span class="i">$uscdb</span> = <span class="i">db_connect</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">acpa_cleanup</span><span class="s">(</span><span class="i">$uscdb</span><span class="s">)</span><span class="sc">;</span>
  
  <span class="k">my</span> <span class="i">$file</span> = <span class="i">$args</span>{<span class="w">MpsLib</span>} . <span class="q">'/test_data/get_counts_inserts.sql'</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">@insert_stmt</span> = <span class="i">get_insert_statements</span><span class="s">(</span><span class="i">$file</span><span class="s">)</span><span class="sc">;</span>
  
  <span class="c"># insert into ac_processing_accounting</span>
  <span class="k">foreach</span> <span class="k">my</span> <span class="i">$insert_sql</span> <span class="s">(</span><span class="i">@insert_stmt</span><span class="s">)</span>
  <span class="s">{</span>
    <span class="k">my</span> <span class="i">$rc</span> = <span class="i">$uscdb</span><span class="i">-&gt;setQuery</span><span class="s">(</span><span class="i">$insert_sql</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">unless</span><span class="s">(</span><span class="k">defined</span> <span class="i">$rc</span><span class="s">)</span>
    <span class="s">{</span>
      <span class="i">$uscdb</span><span class="i">-&gt;closeConnection</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
      <span class="w">croak</span> <span class="q">&quot;Error setting Query\n&quot;</span> . <span class="i">$uscdb</span><span class="i">-&gt;displayError</span><span class="s">(</span><span class="s">)</span> . <span class="q">&quot;$!\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">$rc</span> = <span class="i">$uscdb</span><span class="i">-&gt;runQuery</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">unless</span><span class="s">(</span><span class="k">defined</span> <span class="i">$rc</span><span class="s">)</span>
    <span class="s">{</span>
      <span class="i">$uscdb</span><span class="i">-&gt;closeConnection</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
      <span class="w">croak</span> <span class="q">&quot;Error running Query\n&quot;</span> . <span class="i">$uscdb</span><span class="i">-&gt;displayError</span><span class="s">(</span><span class="s">)</span> . <span class="q">&quot;$!\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
  <span class="s">}</span>
  <span class="i">$uscdb</span><span class="i">-&gt;commit</span><span class="sc">;</span>
  <span class="i">$uscdb</span><span class="i">-&gt;closeConnection</span><span class="sc">;</span>
<span class="s">}</span>


</pre><dt><strong><a name="item_db_setup_for_run_check_nothing_found">db_setup_for_run_check_nothing_found</a></strong><br /></dt>
<p>The setup generated by this subroutine is sufficient for this test.</p>
<pre>
<a name="db_setup_for_run_check_alarm_condition-"></a><span class="k">sub </span><span class="m">db_setup_for_run_check_alarm_condition</span>
<span class="s">{</span>
  <span class="i">db_setup_for_get_counts</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>



</pre><dt><strong>db_setup_for_run_check_nothing found</strong><br /></dt>
<p>Sets up the database for the run_check_nothing_found test.</p>
<pre>
<a name="db_setup_for_run_check_nothing_found-"></a><span class="k">sub </span><span class="m">db_setup_for_run_check_nothing_found</span>
<span class="s">{</span>
  <span class="k">my</span> <span class="i">$uscdb</span> = <span class="i">db_connect</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="i">acpa_cleanup</span><span class="s">(</span><span class="i">$uscdb</span><span class="s">)</span><span class="sc">;</span>
  
  <span class="k">my</span> <span class="i">$file</span> = <span class="i">$args</span>{<span class="w">MpsLib</span>} 
           . <span class="q">'/test_data/get_counts_inserts_nothing_found.sql'</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">@insert_stmt</span> = <span class="i">get_insert_statements</span><span class="s">(</span><span class="i">$file</span><span class="s">)</span><span class="sc">;</span>
  
  <span class="c"># insert into ac_processing_accounting</span>
  <span class="k">foreach</span> <span class="k">my</span> <span class="i">$insert_sql</span> <span class="s">(</span><span class="i">@insert_stmt</span><span class="s">)</span>
  <span class="s">{</span>
    <span class="k">my</span> <span class="i">$rc</span> = <span class="i">$uscdb</span><span class="i">-&gt;setQuery</span><span class="s">(</span><span class="i">$insert_sql</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">unless</span><span class="s">(</span><span class="k">defined</span> <span class="i">$rc</span><span class="s">)</span>
    <span class="s">{</span>
      <span class="i">$uscdb</span><span class="i">-&gt;closeConnection</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
      <span class="w">croak</span> <span class="q">&quot;Error setting Query\n&quot;</span> . <span class="i">$uscdb</span><span class="i">-&gt;displayError</span><span class="s">(</span><span class="s">)</span> . <span class="q">&quot;$!\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">$rc</span> = <span class="i">$uscdb</span><span class="i">-&gt;runQuery</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">unless</span><span class="s">(</span><span class="k">defined</span> <span class="i">$rc</span><span class="s">)</span>
    <span class="s">{</span>
      <span class="i">$uscdb</span><span class="i">-&gt;closeConnection</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
      <span class="w">croak</span> <span class="q">&quot;Error running Query\n&quot;</span> . <span class="i">$uscdb</span><span class="i">-&gt;displayError</span><span class="s">(</span><span class="s">)</span> . <span class="q">&quot;$!\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
  <span class="s">}</span>
  <span class="i">$uscdb</span><span class="i">-&gt;commit</span><span class="sc">;</span>
  <span class="i">$uscdb</span><span class="i">-&gt;closeConnection</span><span class="sc">;</span>
<span class="s">}</span>



</pre><dt><strong><a name="item_db_connect">db_connect</a></strong><br /></dt>
<p>Connects to local or specified in arguments database.
Returns an instanciated USCDB object.</p>
<pre>
<a name="db_connect-"></a><span class="k">sub </span><span class="m">db_connect</span>
<span class="s">{</span>
  <span class="k">my</span> <span class="i">$uscdb</span>       = <span class="w">USCDB</span><span class="w">-&gt;new</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">@connect_str</span> =
    <span class="i">$uscdb</span><span class="i">-&gt;getDBParmsfromOper</span><span class="s">(</span><span class="i">$args</span>{<span class="w">op_job</span>}<span class="cm">,</span>  <span class="i">$args</span>{<span class="w">op_sid</span>}<span class="cm">,</span>
                               <span class="i">$args</span>{<span class="w">op_user</span>}<span class="cm">,</span> <span class="i">$args</span>{<span class="w">op_pass</span>}<span class="s">)</span><span class="sc">;</span>

  <span class="c"># Get rid of white space in the parameter values.</span>
  <span class="k">foreach</span> <span class="k">my</span> <span class="i">$conn</span> <span class="s">(</span><span class="i">@connect_str</span><span class="s">)</span>
  <span class="s">{</span>
      <span class="i">$conn</span> =~ <span class="q">s/\s+//g</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="k">my</span> <span class="i">$rc</span> = <span class="i">$uscdb</span><span class="i">-&gt;openConnection</span><span class="s">(</span><span class="i">@connect_str</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">unless</span> <span class="s">(</span><span class="k">defined</span> <span class="i">$rc</span><span class="s">)</span>
  <span class="s">{</span>
      <span class="w">carp</span> <span class="q">&quot;Could not connect to Oracle!&quot;</span><span class="cm">,</span> <span class="i">$uscdb</span><span class="i">-&gt;getErrorStr</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="q">&quot;\n\n&quot;</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="k">return</span> <span class="i">$uscdb</span><span class="sc">;</span>
<span class="s">}</span>


</pre><dt><strong><a name="item_acpa_cleanup">acpa_cleanup</a></strong><br /></dt>
<p>Deletes everything from ac_processing_accounting.
If a database handle object is passed in, the module will use this object,
otherwise it will establish a new connection.</p>
<pre>
<a name="acpa_cleanup-"></a><span class="k">sub </span><span class="m">acpa_cleanup</span>
<span class="s">{</span>
  <span class="k">my</span> <span class="i">$uscdb</span> = <span class="i">$_</span>[<span class="n">0</span>]<span class="sc">;</span>
  
  <span class="k">unless</span><span class="s">(</span><span class="k">defined</span> <span class="i">$uscdb</span><span class="s">)</span>
  <span class="s">{</span>
    <span class="i">$uscdb</span> = <span class="i">db_connect</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="k">my</span> <span class="i">$cleanup_sql</span> = <span class="q">'DELETE FROM AC_PROCESSING_ACCOUNTING'</span><span class="sc">;</span>
  <span class="k">my</span> <span class="i">$rc</span> = <span class="i">$uscdb</span><span class="i">-&gt;setQuery</span><span class="s">(</span><span class="i">$cleanup_sql</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">unless</span><span class="s">(</span><span class="k">defined</span> <span class="i">$rc</span><span class="s">)</span>
  <span class="s">{</span>
    <span class="i">$uscdb</span><span class="i">-&gt;closeConnection</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="w">croak</span> <span class="i">$uscdb</span><span class="i">-&gt;displayError</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="q">&quot;$!\n&quot;</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="i">$uscdb</span><span class="i">-&gt;runQuery</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">unless</span><span class="s">(</span><span class="k">defined</span> <span class="i">$rc</span><span class="s">)</span>
  <span class="s">{</span>
    <span class="i">$uscdb</span><span class="i">-&gt;closeConnection</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="w">croak</span> <span class="i">$uscdb</span><span class="i">-&gt;displayError</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="q">&quot;$!\n&quot;</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="i">$uscdb</span><span class="i">-&gt;commit</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  
  <span class="c"># disconnect if using your own handle.</span>
  <span class="k">unless</span><span class="s">(</span><span class="k">defined</span> <span class="i">$_</span>[<span class="n">0</span>]<span class="s">)</span>
  <span class="s">{</span>
    <span class="i">$uscdb</span><span class="i">-&gt;closeConnection</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="s">}</span>
<span class="s">}</span>


</pre><dl><dt><strong><a name="item_get_insert_statements">get_insert_statements</a></strong><br />
</dt>
<p>Slurps insert statements into an array.  Returns the array.</p>
</dl>
</dl>
</dl>

<pre>
<a name="get_insert_statements-"></a><span class="k">sub </span><span class="m">get_insert_statements</span>
<span class="s">{</span>
  <span class="k">my</span> <span class="i">$file</span> = <span class="k">shift</span><span class="sc">;</span>
  
  <span class="k">open</span><span class="s">(</span><span class="w">FH</span><span class="cm">,</span><span class="i">$file</span><span class="s">)</span> <span class="k">or</span> <span class="w">croak</span> <span class="q">&quot;Unable to open $file\n&quot;</span>
                        . <span class="q">'Make sure you checked it out from PVCS'</span>
                        . <span class="q">'subproject /ora/vmdb/mps/Monitor/test_data/'</span>
                        . <span class="q">&quot;$!&quot;</span><span class="sc">;</span>
  
  <span class="c"># this slurps insert statements into array</span>
  <span class="k">my</span> <span class="i">@insert_stmt</span> = <span class="k">do</span> <span class="s">{</span> <span class="k">local</span><span class="s">(</span> <span class="i">$/</span> = <span class="q">';'</span> <span class="s">)</span> <span class="sc">;</span> <span class="q">&lt;FH&gt;</span> <span class="s">}</span> <span class="sc">;</span>
  <span class="k">pop</span> <span class="i">@insert_stmt</span><span class="sc">;</span> <span class="c"># remove empty element after the last ';'</span>
  <span class="k">foreach</span> <span class="s">(</span><span class="i">@insert_stmt</span><span class="s">)</span>
  <span class="s">{</span>
    <span class="k">chop</span><span class="sc">;</span> <span class="c"># remove the ';' char</span>
    <span class="q">s/(\n\n|\n$)//</span><span class="sc">;</span> <span class="c"># remove blank lines</span>
  <span class="s">}</span>
  
  <span class="k">return</span> <span class="i">@insert_stmt</span><span class="sc">;</span>
<span class="s">}</span>
<a name="EOF-"></a></pre></body>

</html>
