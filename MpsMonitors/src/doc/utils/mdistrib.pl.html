<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>mdistrib.pl</title>
<link rev="made" href="mailto:" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>mdistrib.pl</h1>

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<ul>

		<li><a href="#mdistrib_pl">mdistrib.pl</a></li>
		<ul>

			<li><a href="#author">AUTHOR</a></li>
			<li><a href="#description">DESCRIPTION</a></li>
			<li><a href="#requirements">REQUIREMENTS</a></li>
			<li><a href="#usage_">USAGE:</a></li>
			<li><a href="#synopsis">SYNOPSIS</a></li>
			<li><a href="#mdistrib_main">mdistrib main</a></li>
			<li><a href="#gather_args__"><code>gather_args()</code></a></li>
			<li><a href="#distrib_all__"><code>distrib_all()</code></a></li>
			<li><a href="#distrib_conf__"><code>distrib_conf()</code></a></li>
			<li><a href="#ftp_connect__"><code>ftp_connect()</code></a></li>
			<li><a href="#todo">TODO</a></li>
		</ul>

	</ul>

</ul>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#gather_args-">package main</a>
<ul>
<li><a href="#gather_args-">gather_args</a></li>
<li><a href="#distrib_all-">distrib_all</a></li>
<li><a href="#distrib_conf-">distrib_conf</a></li>
<li><a href="#ftp_connect-">ftp_connect</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<hr />
<pre>#!/opt/perl5/bin/perl

</pre><p></p>
<h2><a name="mdistrib_pl">mdistrib.pl</a></h2>
<p>
</p>
<h3><a name="author">AUTHOR</a></h3>
<pre>
  Pete Chudykowski</pre>
<p>
</p>
<h3><a name="description">DESCRIPTION</a></h3>
<pre>
  mdistrib.pl is a utility script used to distribute either the monitor.xml
  configuration file or all monitor sources to all the markets and bounce
  the monitors if desired.
  The script is interactive in that at the very least (depending on how much
  information is provided in the configuration file) it will prompt user 
  for production id and password.</pre>
<p>
</p>
<h3><a name="requirements">REQUIREMENTS</a></h3>
<pre>
  Currently, the monitors can only be brought up via remote shell.
  As such, the script will only successfully bounce the monitors if 
  it is executed on a host and by a user, both of which have a valid 
  .rhosts entry on the monitor server hosts.</pre>
<p>
</p>
<h3><a name="usage_">USAGE:</a></h3>
<pre>
  mdistrib.pl [-all] [-cfg] [-c [&lt;path&gt;]]</pre>
<pre>
  -h --help       Display this help message.
  -all            Distribute all sources.
  -cfg            Distribute the configuration file only.</pre>
<pre>
                  If both are set, -all trumps -cfg
  -c              Optionally specify location of the mdistrib config file 
                  if it is not present in the current directory
  -b              Bounce the monitors after distributing.</pre>
<p>
</p>
<h3><a name="synopsis">SYNOPSIS</a></h3>
<pre>
  mdistrib.pl -all -c ./conf/config.xml
  mdistrib.pl -cfg
  mdistrib.pl</pre>
<pre>

<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>

<span class="k">BEGIN</span>
<span class="s">{</span>
  <span class="k">unshift</span> <span class="i">@INC</span><span class="cm">,</span><span class="q">&quot;/users/md1pchu1/lib/perl5/site_perl/5.8.0/&quot;</span><span class="sc">;</span>
<span class="s">}</span>

<span class="k">use</span> <span class="w">Cwd</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Carp</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Net::FTP::Recursive</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">IO::Socket</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">XML::Simple</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Term::ReadKey</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Data::Dumper</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">MonitorControl</span><span class="sc">;</span>

<span class="i">$|</span> = <span class="n">1</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="mdistrib_main">mdistrib main</a></h3>
<pre>
  Gather up arguments and parse the XML configuration file.
  Loop through markets defined in the config.  
    Connect to each market using FTP.  Depending on command 
    line specifications distribute all sources or the monitor
    configuration file only.
    Bounce the monitor if requested.
  End loop.</pre>
<pre>
<span class="k">my</span> <span class="i">%args</span> = <span class="i">gather_args</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$config</span> = <span class="w">XML::Simple</span><span class="w">-&gt;new</span><span class="s">(</span><span class="s">)</span><span class="i">-&gt;XMLin</span><span class="s">(</span><span class="i">$args</span>{<span class="k">-c</span>}<span class="s">)</span><span class="sc">;</span>

<span class="k">foreach</span> <span class="k">my</span> <span class="i">$mkt</span> <span class="s">(</span><span class="k">sort</span><span class="s">(</span><span class="k">keys</span><span class="s">(</span><span class="i">%$config</span><span class="s">)</span><span class="s">)</span><span class="s">)</span> 
<span class="s">{</span>
    <span class="k">print</span> <span class="q">&quot;\n&quot;</span> . <span class="k">uc</span><span class="s">(</span><span class="i">$mkt</span><span class="s">)</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;Initiating FTP connection.\n&quot;</span><span class="sc">;</span> 
    <span class="k">my</span> <span class="i">$ftp</span> = <span class="w">Net::FTP::Recursive</span><span class="w">-&gt;new</span><span class="s">(</span><span class="i">$config</span>-&gt;{<span class="i">$mkt</span>}-&gt;{<span class="w">server</span>}<span class="cm">,</span> 
                                       <span class="w">Debug</span><span class="cm">=&gt;</span><span class="n">0</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">(</span><span class="i">$args</span>{-<span class="w">login</span>}<span class="cm">,</span><span class="i">$args</span>{-<span class="w">pass</span>}<span class="s">)</span> = <span class="i">ftp_connect</span><span class="s">(</span>\<span class="i">$ftp</span><span class="cm">,</span><span class="i">$args</span>{-<span class="w">login</span>}<span class="cm">,</span><span class="i">$args</span>{-<span class="w">pass</span>}<span class="s">)</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;Connection Successful!\n&quot;</span><span class="sc">;</span> 
    
    <span class="k">if</span><span class="s">(</span><span class="k">defined</span> <span class="i">$args</span>{-<span class="w">all</span>}<span class="s">)</span>
    <span class="s">{</span>
      <span class="i">distrib_all</span><span class="s">(</span><span class="i">$ftp</span><span class="cm">,</span> <span class="i">$config</span>-&gt;{<span class="i">$mkt</span>}-&gt;{<span class="w">all</span>}<span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">elsif</span><span class="s">(</span><span class="k">defined</span> <span class="i">$args</span>{-<span class="w">cfg</span>}<span class="s">)</span>
    <span class="s">{</span>
      <span class="i">distrib_conf</span><span class="s">(</span><span class="i">$ftp</span><span class="cm">,</span> <span class="i">$config</span>-&gt;{<span class="i">$mkt</span>}-&gt;{<span class="w">cfg</span>}<span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span>
    <span class="s">{</span>
      <span class="w">croak</span> <span class="q">&quot;Unable to set distribution mode\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
 
    <span class="i">$ftp</span><span class="i">-&gt;quit</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
     
    <span class="k">if</span><span class="s">(</span><span class="k">defined</span> <span class="i">$args</span>{<span class="k">-b</span>}<span class="s">)</span>
    <span class="s">{</span>
      <span class="k">print</span> <span class="q">&quot;Bouncing the &quot;</span> . <span class="k">uc</span><span class="s">(</span><span class="i">$mkt</span><span class="s">)</span> . <span class="q">&quot; Monitors.\n&quot;</span><span class="sc">;</span>
      <span class="k">my</span> <span class="i">$mon</span> = <span class="w">MonitorControl</span><span class="w">-&gt;new</span><span class="s">(</span><span class="w">server</span><span class="cm">=&gt;</span><span class="i">$config</span>-&gt;{<span class="i">$mkt</span>}-&gt;{<span class="w">server</span>}<span class="cm">,</span>
                                    <span class="w">port</span><span class="cm">=&gt;</span><span class="i">$config</span>-&gt;{<span class="i">$mkt</span>}-&gt;{<span class="w">port</span>}<span class="cm">,</span>
                                    <span class="w">login</span><span class="cm">=&gt;</span><span class="i">$config</span>-&gt;{<span class="i">$mkt</span>}-&gt;{<span class="w">login</span>}<span class="cm">,</span>
                                    <span class="w">passwd</span><span class="cm">=&gt;</span><span class="i">$args</span>{-<span class="w">pass</span>}<span class="cm">,</span>
                                    <span class="w">location</span><span class="cm">=&gt;</span><span class="i">$config</span>-&gt;{<span class="i">$mkt</span>}-&gt;{<span class="w">location</span>}<span class="s">)</span><span class="sc">;</span>
      <span class="i">$mon</span><span class="i">-&gt;bounce</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
      <span class="k">print</span> <span class="q">&quot;Bounce complete.\n\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">print</span> <span class="q">&quot;Distribution to &quot;</span> . <span class="k">uc</span><span class="s">(</span><span class="i">$mkt</span><span class="s">)</span> . <span class="q">&quot; complete.\n\n&quot;</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="gather_args__"><code>gather_args()</code></a></h3>
<pre>

  Gather required arguments.
  First Check if flags are set on the command line.
  If applicable try default.
  Otherwise (or if default does not work) switch to 
  interactive mode and ask for directions.</pre>
<pre>
<a name="gather_args-"></a><span class="k">sub </span><span class="m">gather_args</span>
<span class="s">{</span>
  
  <span class="k">my</span> <span class="i">%args</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  
  <span class="c"># If they're asking for help, sigh ostentatiously and give it to them.</span>
  <span class="k">if</span><span class="s">(</span><span class="k">grep</span> <span class="q">/-h/</span><span class="cm">,</span> <span class="i">@ARGV</span> <span class="k">or</span> <span class="k">grep</span> <span class="q">/--help/</span><span class="cm">,</span> <span class="i">@ARGV</span><span class="s">)</span>
  <span class="s">{</span>
    <span class="k">print</span> <span class="q">&quot;\nUSAGE: mdistrib.pl [-all] [-cfg] [-c [&lt;path&gt;]]\n\n&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;-h --help \tDisplay this help message.\n&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;-all \t\tDistribute all sources.\n&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;-cfg \t\tDistribute the configuration file only.\n&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;\n\t\tIf both are set, -all trumps -cfg\n&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;-c \t\tOptionally specify location of the mdistrib config file &quot;</span>
        . <span class="q">&quot;if it is not present in the current directory\n&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;-b\t\tBounce the monitors after distributing.\n&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;EXAMPLES:\n&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;mdistrib.pl -all -c ./conf/config.xml\n&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;mdistrib.pl -cfg\n&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;mdistrib.pl\n\n&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;Default values are used if no arguments are provided.\n&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;If default is impossible to determine, the script will switch &quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;to interactive mode.\n\n&quot;</span><span class="sc">;</span>
    <span class="k">exit</span> <span class="n">-1</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="c"># The -c flag specifies the location of the config file.</span>
  <span class="c"># If the flag is not supplied, check if 'config.xml' happens </span>
  <span class="c"># to be in the current directory.</span>
  <span class="c"># If all else fails, switch to interactive mode and ask where</span>
  <span class="c"># the config file is.</span>
  <span class="k">if</span><span class="s">(</span><span class="k">grep</span> <span class="q">/-c/</span><span class="cm">,</span> <span class="i">@ARGV</span><span class="s">)</span>
  <span class="s">{</span>
    <span class="c"># the token following the -c flag should be a path to the </span>
    <span class="c"># configuration file.</span>
    <span class="k">for</span><span class="s">(</span><span class="k">my</span> <span class="i">$i</span>=<span class="n">0</span><span class="sc">;</span> <span class="i">$i</span>&lt;<span class="i">@ARGV</span><span class="sc">;</span> <span class="i">$i</span>++<span class="s">)</span>
    <span class="s">{</span>
      <span class="k">if</span><span class="s">(</span><span class="i">$ARGV</span>[<span class="i">$i</span>] <span class="k">eq</span> <span class="q">&quot;-c&quot;</span><span class="s">)</span>
      <span class="s">{</span>
        <span class="i">$args</span>{<span class="k">-c</span>} = <span class="i">$ARGV</span>[<span class="i">$i</span>+<span class="n">1</span>]<span class="sc">;</span>
        <span class="k">last</span><span class="sc">;</span> 
      <span class="s">}</span>
    <span class="s">}</span>
  <span class="s">}</span>
  <span class="k">else</span>
  <span class="s">{</span>
    <span class="i">$args</span>{<span class="k">-c</span>} = <span class="k">undef</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="c"># now check if the supplied file actually exists.</span>
  <span class="k">unless</span><span class="s">(</span><span class="k">-e</span> <span class="i">$args</span>{<span class="k">-c</span>}<span class="s">)</span>
  <span class="s">{</span>
    <span class="k">if</span><span class="s">(</span><span class="k">defined</span> <span class="i">$args</span>{<span class="k">-c</span>}<span class="s">)</span>
    <span class="s">{</span>
      <span class="k">print</span> <span class="i">$args</span>{<span class="k">-c</span>} <span class="cm">,</span> <span class="q">&quot; does not exist.\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">print</span> <span class="q">&quot;\nLooking for config.xml in the current directory ... &quot;</span><span class="sc">;</span>
    <span class="k">if</span><span class="s">(</span><span class="k">-e</span> <span class="q">&quot;./config.xml&quot;</span><span class="s">)</span>
    <span class="s">{</span>
      <span class="k">print</span> <span class="q">&quot;Got it!\n\n&quot;</span><span class="sc">;</span>
      <span class="i">$args</span>{<span class="k">-c</span>} = <span class="q">&quot;./config.xml&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">else</span>
    <span class="s">{</span>
      <span class="k">print</span> <span class="q">&quot;no luck.\n&quot;</span><span class="sc">;</span>
      <span class="k">while</span><span class="s">(</span><span class="n">1</span><span class="s">)</span>
      <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;\nUnable to find config.xml.  &quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;Enter location: &quot;</span><span class="sc">;</span>
        <span class="i">$args</span>{<span class="k">-c</span>} = <span class="q">&lt;STDIN&gt;</span><span class="sc">;</span>
        <span class="k">chomp</span> <span class="i">$args</span>{<span class="k">-c</span>}<span class="sc">;</span>
        <span class="c"># again, check if the supplied file actually exists;</span>
        <span class="k">last</span> <span class="k">if</span><span class="s">(</span><span class="k">-e</span> <span class="i">$args</span>{<span class="k">-c</span>}<span class="s">)</span><span class="sc">;</span>
      <span class="s">}</span>
    <span class="s">}</span> <span class="c"># end if-else</span>
  <span class="s">}</span> <span class="c"># end unless</span>
  
  <span class="c"># Check for flags -all and -cfg</span>
  <span class="c"># -all means that everything is to be distributed.</span>
  <span class="c"># -cfg means that only the config.xml is to be distributed.</span>
  <span class="c"># if both are set, -all trumps -cfg.</span>
  <span class="k">if</span><span class="s">(</span><span class="k">grep</span> <span class="q">/-cfg/</span><span class="cm">,</span> <span class="i">@ARGV</span><span class="s">)</span>
  <span class="s">{</span>
      <span class="i">$args</span>{-<span class="w">cfg</span>}=<span class="q">'true'</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="k">else</span>
  <span class="s">{</span>
    <span class="i">$args</span>{-<span class="w">cfg</span>} = <span class="k">undef</span><span class="sc">;</span>
  <span class="s">}</span>
  
  
  <span class="k">if</span><span class="s">(</span><span class="k">grep</span> <span class="q">/-all/</span><span class="cm">,</span> <span class="i">@ARGV</span><span class="s">)</span>
  <span class="s">{</span>
    <span class="i">$args</span>{-<span class="w">all</span>} = <span class="q">'true'</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="k">else</span> 
  <span class="s">{</span>
    <span class="i">$args</span>{-<span class="w">all</span>} = <span class="k">undef</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="c"># if neither is defined, ask.</span>
  <span class="k">if</span><span class="s">(</span>!<span class="k">defined</span> <span class="i">$args</span>{-<span class="w">cfg</span>} &amp;&amp; !<span class="k">defined</span> <span class="i">$args</span>{-<span class="w">all</span>}<span class="s">)</span>
  <span class="s">{</span>
    <span class="k">while</span><span class="s">(</span><span class="n">1</span><span class="s">)</span>
    <span class="s">{</span>
      <span class="k">print</span> <span class="q">&quot;\nUnable to determine transfer mode.\n&quot;</span><span class="sc">;</span>
      <span class="k">print</span> <span class="q">&quot;Distribute all files (a) or config file only (c)? [a|c] : &quot;</span><span class="sc">;</span>
      <span class="k">my</span> <span class="i">$resp</span> = <span class="q">&lt;STDIN&gt;</span><span class="sc">;</span>
      <span class="k">chomp</span> <span class="i">$resp</span><span class="sc">;</span>
      <span class="k">if</span><span class="s">(</span><span class="i">$resp</span> <span class="k">eq</span> <span class="q">&quot;a&quot;</span><span class="s">)</span>
      <span class="s">{</span>
        <span class="i">$args</span>{-<span class="w">all</span>} = <span class="q">'true'</span><span class="sc">;</span>
        <span class="k">last</span><span class="sc">;</span>
      <span class="s">}</span>
      <span class="k">elsif</span><span class="s">(</span><span class="i">$resp</span> <span class="k">eq</span> <span class="q">&quot;c&quot;</span><span class="s">)</span>
      <span class="s">{</span>
        <span class="i">$args</span>{-<span class="w">cfg</span>} = <span class="q">'true'</span><span class="sc">;</span>
        <span class="k">last</span><span class="sc">;</span>
      <span class="s">}</span>
      <span class="k">print</span> <span class="q">&quot;\nInvalid Response.  Valid responses are 'a', or 'c'.\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
  <span class="s">}</span>

  <span class="c"># The flag -b if set will</span>
  <span class="k">if</span><span class="s">(</span><span class="k">grep</span> <span class="q">/-b/</span><span class="cm">,</span> <span class="i">@ARGV</span><span class="s">)</span>
  <span class="s">{</span>
      <span class="i">$args</span>{<span class="k">-b</span>}=<span class="q">'true'</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="k">else</span>
  <span class="s">{</span>
    <span class="i">$args</span>{<span class="k">-b</span>} = <span class="k">undef</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="k">return</span> <span class="i">%args</span><span class="sc">;</span>  
<span class="s">}</span>


</pre><p></p>
<h3><a name="distrib_all__"><code>distrib_all()</code></a></h3>
<pre>
  Recursively FTP the entire directory supplied in $config.</pre>
<pre>
<a name="distrib_all-"></a><span class="k">sub </span><span class="m">distrib_all</span>
<span class="s">{</span>
  <span class="k">my</span><span class="s">(</span><span class="i">$ftp</span><span class="cm">,</span><span class="i">$cfg</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
  
  <span class="i">$ftp</span><span class="i">-&gt;cwd</span><span class="s">(</span><span class="i">$cfg</span>-&gt;{<span class="w">dest</span>}<span class="s">)</span><span class="sc">;</span>
  <span class="w">carp</span> <span class="q">&quot;\nUnable to cd to $cfg-&gt;{dest}\n&quot;</span> 
     . <span class="i">$ftp</span><span class="i">-&gt;message</span><span class="s">(</span><span class="s">)</span> <span class="k">unless</span> <span class="k">defined</span> <span class="i">$ftp</span><span class="sc">;</span>
 
  <span class="i">$ftp</span><span class="i">-&gt;ascii</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  
<span class="c">#  print Dumper($cfg);</span>
  
  <span class="c"># first determine if the local entry directory exists</span>
  <span class="k">unless</span><span class="s">(</span><span class="k">-e</span> <span class="i">$cfg</span>-&gt;{<span class="w">dir</span>}<span class="s">)</span>
  <span class="s">{</span>
    <span class="w">croak</span> <span class="q">&quot;$cfg-&gt;{dir} does not exist!\n&quot;</span><span class="sc">;</span>
  <span class="s">}</span>
  <span class="c"># check if it is a directory</span>
  <span class="k">unless</span><span class="s">(</span><span class="k">-d</span> <span class="i">$cfg</span>-&gt;{<span class="w">dir</span>}<span class="s">)</span>
  <span class="s">{</span>
    <span class="w">croak</span> <span class="q">&quot;$cfg-&gt;{dir} is not a directory!\n&quot;</span>
  <span class="s">}</span>
  
  <span class="c"># cd into the local entry directory.</span>
  <span class="k">chdir</span><span class="s">(</span><span class="i">$cfg</span>-&gt;{<span class="w">dir</span>}<span class="s">)</span> 
    <span class="k">or</span> <span class="w">croak</span> <span class="q">&quot;Unable to cd into $cfg-&gt;{dir}!\n$!\n&quot;</span><span class="sc">;</span>
  
  <span class="c"># create the empty destination directory if doesn't already exist.</span>
  <span class="i">$ftp</span><span class="i">-&gt;mkdir</span><span class="s">(</span><span class="i">$cfg</span>-&gt;{<span class="w">dest</span>}<span class="s">)</span><span class="sc">;</span>

  <span class="c"># change remote directory to dest</span>
  <span class="k">print</span> <span class="q">&quot;Changing directory to $cfg-&gt;{dest}\n&quot;</span><span class="sc">;</span>
  <span class="i">$ftp</span><span class="i">-&gt;cwd</span><span class="s">(</span><span class="i">$cfg</span>-&gt;{<span class="w">dest</span>}<span class="s">)</span><span class="sc">;</span>
  
  <span class="c"># FTP directory recursively</span>
  <span class="k">print</span> <span class="q">&quot;Transferring files (this can take awhile) ... &quot;</span><span class="sc">;</span>
  <span class="i">$ftp</span><span class="i">-&gt;rput</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  <span class="k">print</span> <span class="q">&quot;done.\n&quot;</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="distrib_conf__"><code>distrib_conf()</code></a></h3>
<pre>
  Distribute only the monitor configuration file.</pre>
<pre>
<a name="distrib_conf-"></a><span class="k">sub </span><span class="m">distrib_conf</span>
<span class="s">{</span>
  <span class="k">my</span><span class="s">(</span><span class="i">$ftp</span><span class="cm">,</span><span class="i">$cfg</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
  
  <span class="i">$ftp</span><span class="i">-&gt;mkdir</span><span class="s">(</span><span class="i">$cfg</span>-&gt;{<span class="w">dest</span>}<span class="s">)</span><span class="sc">;</span>
  <span class="i">$ftp</span><span class="i">-&gt;cwd</span><span class="s">(</span><span class="i">$cfg</span>-&gt;{<span class="w">dest</span>}<span class="s">)</span>
    <span class="k">or</span> <span class="w">croak</span> <span class="q">&quot;\nUnable to cd to $cfg-&gt;{dest}\n&quot;</span> 
           . <span class="i">$ftp</span><span class="i">-&gt;message</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
 
  <span class="i">$ftp</span><span class="i">-&gt;ascii</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
  
  <span class="k">unless</span><span class="s">(</span><span class="k">-e</span> <span class="i">$cfg</span>-&gt;{<span class="w">file</span>}<span class="s">)</span>
  <span class="s">{</span>
    <span class="w">croak</span> <span class="i">$cfg</span>-&gt;{<span class="w">file</span>}<span class="cm">,</span> <span class="q">&quot; does not exist!\n$!\n&quot;</span><span class="sc">;</span>
  <span class="s">}</span>
  
  <span class="k">print</span> <span class="q">&quot;Transferring file ... &quot;</span><span class="sc">;</span>
  <span class="i">$ftp</span><span class="i">-&gt;put</span><span class="s">(</span><span class="i">$cfg</span>-&gt;{<span class="w">file</span>}<span class="s">)</span>
    <span class="k">or</span> <span class="w">croak</span> <span class="q">&quot;Unable to FTP $cfg-&gt;{file}\n&quot;</span><span class="sc">;</span>
  <span class="k">print</span> <span class="q">&quot;done.\n&quot;</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="ftp_connect__"><code>ftp_connect()</code></a></h3>
<pre>
  Try connecting using supplied password.
  Retry until successfull.</pre>
<pre>
<a name="ftp_connect-"></a><span class="k">sub </span><span class="m">ftp_connect</span>
<span class="s">{</span>
    <span class="k">my</span><span class="s">(</span><span class="i">$ftp</span><span class="cm">,</span><span class="i">$login</span><span class="cm">,</span><span class="i">$pass</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    
    <span class="k">unless</span><span class="s">(</span><span class="k">defined</span> <span class="i">$login</span><span class="s">)</span>
    <span class="s">{</span> 
      <span class="k">print</span> <span class="q">&quot;\nEnter production login ID: &quot;</span><span class="sc">;</span>
      <span class="i">$login</span> = <span class="q">&lt;STDIN&gt;</span><span class="sc">;</span>
      <span class="k">chomp</span> <span class="i">$login</span><span class="sc">;</span>
    <span class="s">}</span>
    
    <span class="k">unless</span><span class="s">(</span><span class="k">defined</span> <span class="i">$pass</span><span class="s">)</span>
    <span class="s">{</span> 
      <span class="k">print</span> <span class="q">&quot;\nEnter production password for $login: &quot;</span><span class="sc">;</span>
      <span class="i">ReadMode</span><span class="s">(</span><span class="q">'noecho'</span><span class="s">)</span><span class="sc">;</span>
      <span class="i">$pass</span> = <span class="q">&lt;STDIN&gt;</span><span class="sc">;</span> <span class="c">#ReadLine(0);</span>
      <span class="k">chomp</span> <span class="i">$pass</span><span class="sc">;</span>
      <span class="i">ReadMode</span><span class="s">(</span><span class="q">'normal'</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">eval</span>
    <span class="s">{</span>
      <span class="i">$$ftp</span><span class="i">-&gt;login</span><span class="s">(</span><span class="i">$login</span><span class="cm">,</span> <span class="i">$pass</span><span class="s">)</span>
                  <span class="k">or</span> <span class="w">croak</span> <span class="q">&quot;\nInvalid Username or Password!\n&quot;</span><span class="sc">;</span>  
    <span class="s">}</span><span class="sc">;</span>
    <span class="k">if</span><span class="s">(</span><span class="i">$@</span><span class="s">)</span>
    <span class="s">{</span>
      <span class="k">print</span> <span class="q">&quot;\nInvalid Password.  Try again.\n&quot;</span><span class="sc">;</span>
      <span class="i">ftp_connect</span><span class="s">(</span><span class="i">$ftp</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="s">(</span><span class="i">$login</span><span class="cm">,</span><span class="i">$pass</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>  

</pre><p></p>
<h3><a name="todo">TODO</a></h3>
<pre>
  Thread the start method instead of looping to speed up the process of
  bringing up the monitors.</pre>

<pre><a name="EOF-"></a></pre></body>

</html>
