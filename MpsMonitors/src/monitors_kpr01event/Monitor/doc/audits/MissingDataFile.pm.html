<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>MissingDataFile.pm</title>
<link rev="made" href="mailto:" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>MissingDataFile.pm</h1>

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<ul>

		<li><a href="#package_missingdatafile">PACKAGE  MissingDataFile</a></li>
		<ul>

			<li><a href="#author">AUTHOR</a></li>
			<li><a href="#synopsis">SYNOPSIS</a></li>
			<li><a href="#reqirements">REQIREMENTS</a></li>
			<li><a href="#description">DESCRIPTION</a></li>
		</ul>

		<li><a href="#methods">METHODS</a></li>
		<ul>

			<li><a href="#new__"><code>new()</code></a></li>
			<li><a href="#run_check__"><code>run_check()</code></a></li>
			<li><a href="#get_from_hrs_ago__"><code>get_from_hrs_ago()</code></a></li>
			<li><a href="#get_to_hrs_ago__"><code>get_to_hrs_ago()</code></a></li>
			<li><a href="#get_switches__"><code>get_switches()</code></a></li>
			<li><a href="#skip_first_day__"><code>skip_first_day()</code></a></li>
		</ul>

	</ul>

</ul>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-Monitor::MissingDataFile-">package Monitor::MissingDataFile</a>
<ul>
<li><a href="#new-">new</a></li>
<li><a href="#run_check-">run_check</a></li>
<li><a href="#get_from_hrs_ago-">get_from_hrs_ago</a></li>
<li><a href="#get_to_hrs_ago-">get_to_hrs_ago</a></li>
<li><a href="#get_switches-">get_switches</a></li>
<li><a href="#skip_first_day-">skip_first_day</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<hr />
<pre>#!/opt/perl5/bin/perl

</pre><p></p>
<h2><a name="package_missingdatafile">PACKAGE  MissingDataFile</a></h2>
<p>
</p>
<h3><a name="author">AUTHOR</a></h3>
<pre>
  Pete Chudykowski</pre>
<p>
</p>
<h3><a name="synopsis">SYNOPSIS</a></h3>
<pre>
  use Monitor::MissingDataFile; 
  
  my $check  = Monitor::MissingDataFile-&gt;new(@arg_list); 
  my $result = $check-&gt;run_check();
  
  use Monitor::MissingDataFile;
  
  my $check  = Monitor::MissingDataFile-&gt;new(%arg_hash) 
  my $result = $check-&gt;run_check();</pre>
<p>
</p>
<h3><a name="reqirements">REQIREMENTS</a></h3>
<pre>
  - Inherits the Monitor package and its instance variables.
  - Check is performed by a main method called run_check, which returns a 
    scalar containing a B&lt;formatted string&gt;, which will be displayed verbatim
    by the Monitor interfaces.</pre>
<p>
</p>
<h3><a name="description">DESCRIPTION</a></h3>
<pre>
    Reports missing data files.</pre>
<pre>
<a name="package-Monitor::MissingDataFile-"></a><span class="k">package </span><span class="i">Monitor::MissingDataFile</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">warnings</span><span class="sc">;</span>

<span class="k">BEGIN</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="i">%args</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">push</span> <span class="i">@INC</span><span class="cm">,</span> <span class="i">$args</span>{<span class="w">MpsLib</span>}<span class="sc">;</span>
<span class="s">}</span>

<span class="k">use</span> <span class="w">base</span> <span class="q">qw(Monitor)</span><span class="sc">;</span>    <span class="c"># Monitor is the base (parent) class.</span>

<span class="k">use</span> <span class="w">Carp</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">USCDB</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Time::Local</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Data::Dumper</span><span class="sc">;</span>

</pre><p></p>
<h2><a name="methods">METHODS</a></h2>
<p>
</p>
<h3><a name="new__"><code>new()</code></a></h3>
<pre>
  Constructor.
  Creates an instance of MissingDataFile.
  Sets the class variables from argument pairs.
  
  Returns: a reference to the instanciated object.</pre>
<pre>
<a name="new-"></a><span class="k">sub </span><span class="m">new()</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$class</span><span class="cm">,</span> <span class="i">%args</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="w">Monitor</span><span class="w">-&gt;new</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>    <span class="c"># inherit Monitor's instance variables.</span>

    <span class="c"># Add properties passed in to the hash of instance variables.</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span><span class="k">keys</span><span class="s">(</span><span class="i">%args</span><span class="s">)</span><span class="s">)</span>
    <span class="s">{</span>
        <span class="i">$self</span>-&gt;{<span class="i">$key</span>} = <span class="i">$args</span>{<span class="i">$key</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">bless</span> <span class="i">$self</span><span class="cm">,</span> <span class="i">$class</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="run_check__"><code>run_check()</code></a></h3>
<pre>
    Performs the MissingDataFile check.
        
    Returns: Multi-line string scalar that contains the list of 
             switches and their missing blocks.
    Or:      undef if no files are late.</pre>
<pre>
<a name="run_check-"></a><span class="k">sub </span><span class="m">run_check</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="i">$self</span>    = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$message</span> = <span class="k">undef</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$dbh</span>      = <span class="i">$self</span><span class="i">-&gt;get_cares_db</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@switches</span> = <span class="i">$self</span><span class="i">-&gt;get_switches</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$mdf_query</span> = <span class="i">$self</span><span class="i">-&gt;get_sql_query</span><span class="s">(</span><span class="i">$self</span>-&gt;{<span class="w">SqlLib</span>} . <span class="i">$self</span>-&gt;{<span class="w">sql_query</span>}<span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$rc</span>        = <span class="i">$dbh</span><span class="i">-&gt;setQuery</span><span class="s">(</span><span class="i">$mdf_query</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span>!<span class="k">defined</span> <span class="i">$rc</span><span class="s">)</span>
    <span class="s">{</span>
        <span class="w">croak</span> <span class="q">&quot;\nError in setQuery: \n&quot;</span><span class="cm">,</span> <span class="i">$dbh</span><span class="i">-&gt;getErrorStr</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="q">&quot;\n\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># Loop through the applicable switches.</span>
    <span class="c"># Check for gaps one switch at a time.</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$switch</span> <span class="s">(</span><span class="i">@switches</span><span class="s">)</span>
    <span class="s">{</span>

        <span class="c"># execute query with the appropriate bind variables.</span>
        <span class="i">$rc</span> =
          <span class="i">$dbh</span><span class="i">-&gt;runQuery</span><span class="s">(</span><span class="i">$self</span>-&gt;{<span class="w">from_hrs_ago</span>}<span class="cm">,</span> <span class="i">$self</span>-&gt;{<span class="w">to_hrs_ago</span>}<span class="cm">,</span> <span class="i">$switch</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span>!<span class="k">defined</span> <span class="i">$rc</span><span class="s">)</span>
        <span class="s">{</span>
            <span class="w">croak</span> <span class="q">&quot;\nError in runQuery: \n&quot;</span><span class="cm">,</span> <span class="i">$dbh</span><span class="i">-&gt;getErrorStr</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="q">&quot;\n\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">my</span> <span class="i">$prev_end_block</span> = <span class="i">$self</span><span class="i">-&gt;skip_first_day</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">while</span> <span class="s">(</span>
               <span class="k">my</span> <span class="s">(</span>
                   <span class="i">$identifier</span><span class="cm">,</span>  <span class="i">$orig_id</span><span class="cm">,</span>     <span class="i">$sensor_id</span><span class="cm">,</span>
                   <span class="i">$record_date</span><span class="cm">,</span> <span class="i">$start_block</span><span class="cm">,</span> <span class="i">$end_block</span>
                  <span class="s">)</span>
               = <span class="i">$dbh</span><span class="i">-&gt;fetchResults</span><span class="s">(</span><span class="s">)</span>
              <span class="s">)</span>
        <span class="s">{</span>

            <span class="k">my</span> <span class="i">$gap</span> =
              <span class="i">$start_block</span> - <span class="s">(</span><span class="s">(</span><span class="i">$prev_end_block</span> + <span class="n">1</span><span class="s">)</span> % <span class="i">$self</span>-&gt;{<span class="w">max_blocks</span>}<span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$gap</span> &gt; <span class="n">0</span><span class="s">)</span>
            <span class="s">{</span>
                <span class="i">$message</span> .=
                    <span class="q">&quot;switch:  $switch\n&quot;</span>
                  . <span class="q">&quot;missing: &quot;</span>
                  . <span class="i">$gap</span> . <span class="q">&quot;\n&quot;</span>
                  . <span class="q">&quot;blocks:  &quot;</span>
                  . <span class="s">(</span><span class="i">$prev_end_block</span> + <span class="n">1</span><span class="s">)</span>
                  . <span class="q">&quot; -&gt; $start_block\n&quot;</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="i">$prev_end_block</span> = <span class="i">$end_block</span><span class="sc">;</span>
        <span class="s">}</span>    <span class="c"># end while</span>
    <span class="s">}</span>    <span class="c"># end foreach</span>

    <span class="i">$dbh</span><span class="i">-&gt;closeConnection</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$message</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="get_from_hrs_ago__"><code>get_from_hrs_ago()</code></a></h3>
<pre>
    Accessor method.
    Returns the value of the instance variable 'from_hrs_ago'.</pre>
<pre>
<a name="get_from_hrs_ago-"></a><span class="k">sub </span><span class="m">get_from_hrs_ago</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span>-&gt;{<span class="w">from_hrs_ago</span>}<span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="get_to_hrs_ago__"><code>get_to_hrs_ago()</code></a></h3>
<pre>
    Accessor method.
    Returns the value of the instance variable 'to_hrs_ago'.</pre>
<pre>
<a name="get_to_hrs_ago-"></a><span class="k">sub </span><span class="m">get_to_hrs_ago</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="i">$self</span> = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$self</span>-&gt;{<span class="w">to_hrs_ago</span>}<span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="get_switches__"><code>get_switches()</code></a></h3>
<pre>
    Retrieve valid market switches from the CARES database.</pre>
<pre>
<a name="get_switches-"></a><span class="k">sub </span><span class="m">get_switches</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="i">$self</span>         = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dbh</span>          = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$switch_query</span> =
      <span class="i">$self</span><span class="i">-&gt;get_sql_query</span><span class="s">(</span><span class="i">$self</span>-&gt;{<span class="w">SqlLib</span>} . <span class="i">$self</span>-&gt;{<span class="w">switch_query</span>}<span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$rc</span> = <span class="i">$dbh</span><span class="i">-&gt;setQuery</span><span class="s">(</span><span class="i">$switch_query</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span>!<span class="k">defined</span> <span class="i">$rc</span><span class="s">)</span>
    <span class="s">{</span>
        <span class="w">croak</span> <span class="q">&quot;\nError in setQuery: \n&quot;</span><span class="cm">,</span> <span class="i">$dbh</span><span class="i">-&gt;getErrorStr</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="q">&quot;\n\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># execute query with the appropriate bind variables.</span>
    <span class="i">$rc</span> = <span class="i">$dbh</span><span class="i">-&gt;runQuery</span><span class="s">(</span><span class="i">$self</span>-&gt;{<span class="w">from_hrs_ago</span>}<span class="cm">,</span> <span class="i">$self</span>-&gt;{<span class="w">to_hrs_ago</span>}<span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span>!<span class="k">defined</span> <span class="i">$rc</span><span class="s">)</span>
    <span class="s">{</span>
        <span class="w">croak</span> <span class="q">&quot;\nError in runQuery: \n&quot;</span><span class="cm">,</span> <span class="i">$dbh</span><span class="i">-&gt;getErrorStr</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="q">&quot;\n\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@switches</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span><span class="k">my</span> <span class="s">(</span><span class="i">$switch</span><span class="s">)</span> = <span class="i">$dbh</span><span class="i">-&gt;fetchResults</span><span class="s">(</span><span class="s">)</span><span class="s">)</span>
    <span class="s">{</span>

        <span class="c"># do not add switches in the ignore list.</span>
        <span class="k">unless</span> <span class="s">(</span><span class="k">grep</span> <span class="i">$_</span> <span class="k">eq</span> <span class="i">$switch</span><span class="cm">,</span> <span class="k">split</span><span class="s">(</span><span class="q">/,/</span><span class="cm">,</span> <span class="i">$self</span>-&gt;{<span class="w">ignore_list</span>}<span class="s">)</span><span class="s">)</span>
        <span class="s">{</span>
            <span class="k">push</span><span class="s">(</span><span class="i">@switches</span><span class="cm">,</span> <span class="i">$switch</span><span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">@switches</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="skip_first_day__"><code>skip_first_day()</code></a></h3>
<pre>
    A file that came in late in the past can cause issues when it
    is young enough to transcend the check threshold boundry while
    the next logical block is older and no longer returned by the 
    check query thus creating an artificial block gap.
    This issue can be avoided by reading in an extra day of records.  
    The records are then ordered correctly, and the additional day
    of usage can be ignored.</pre>

<pre>
<a name="skip_first_day-"></a><span class="k">sub </span><span class="m">skip_first_day</span>
<span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$self</span><span class="cm">,</span> <span class="i">$dbh</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span>
           <span class="k">my</span> <span class="s">(</span>
               <span class="i">$identifier</span><span class="cm">,</span> <span class="i">$orig_id</span><span class="cm">,</span> <span class="i">$switch</span><span class="cm">,</span> <span class="i">$record_date</span><span class="cm">,</span> <span class="i">$start_block</span><span class="cm">,</span>
               <span class="i">$end_block</span>
              <span class="s">)</span>
           = <span class="i">$dbh</span><span class="i">-&gt;fetchResults</span><span class="s">(</span><span class="s">)</span>
          <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$yyyy</span><span class="cm">,</span> <span class="i">$mm</span><span class="cm">,</span> <span class="i">$dd</span><span class="cm">,</span> <span class="i">$hh24</span><span class="cm">,</span> <span class="i">$mi</span><span class="cm">,</span> <span class="i">$ss</span><span class="s">)</span> = <span class="k">split</span><span class="s">(</span><span class="q">/[-:\s+]/</span><span class="cm">,</span> <span class="i">$record_date</span><span class="s">)</span><span class="sc">;</span>

        <span class="c"># If the record_date is older than the paging timeframe, skip to the next record.</span>
        <span class="c"># Once you encounter a record within the paging timeframe, exit the loop.</span>
        <span class="k">if</span> <span class="s">(</span><span class="s">(</span><span class="k">time</span><span class="s">(</span><span class="s">)</span> - <span class="i">timelocal</span><span class="s">(</span><span class="i">$ss</span><span class="cm">,</span> <span class="i">$mi</span><span class="cm">,</span> <span class="i">$hh24</span><span class="cm">,</span> <span class="i">$dd</span><span class="cm">,</span> <span class="i">$mm</span> - <span class="n">1</span><span class="cm">,</span> <span class="i">$yyyy</span><span class="s">)</span><span class="s">)</span> &gt;
            <span class="s">(</span><span class="n">60</span> * <span class="n">60</span> * <span class="i">$self</span>-&gt;{<span class="w">from_hrs_ago</span>}<span class="s">)</span><span class="s">)</span>
        <span class="s">{</span>
            <span class="k">next</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">else</span>
        <span class="s">{</span>

            <span class="c"># the current row is witin the check time frame.</span>
            <span class="c"># return the end block so it can be used as previous end block</span>
            <span class="c"># in the first comparison.</span>
            <span class="k">return</span> <span class="i">$end_block</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>    <span class="c">#end while</span>
<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>
<a name="EOF-"></a></pre></body>

</html>
